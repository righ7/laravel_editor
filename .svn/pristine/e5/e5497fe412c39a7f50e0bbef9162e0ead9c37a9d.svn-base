$(document).on('click','.addCover label',function () {
    var type=$(this).text().trim();
    if(type=='单图'){
        $('.addCover .oneImgBox').show();
        $('.addCover .threeImgBox').hide();
    }
    else{
        $('.addCover .threeImgBox').show();
        $('.addCover .oneImgBox').hide();
    }
});
//单图
$(document).on('click','.addCover .oneImgBox',function () {
    var dialogCover='<div class="dialogCover">'+
        '<button type="button" class="btn btn-primary selImgBtn">选择图片</button>' +
        '<button type="button" class="btn btn-success sureImgBtn">确定</button>' +
        '<button type="button" class="btn btn-warning closeImgBtn">取消</button>' +
        '<div class="head">' +
        '<img id="target" />' +
        '<input type="file" id="file" style="display: none;"/>' +
        '</div>' +
        '</div>';
    $('html body').append(dialogCover);

    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        $target = $('#target');
    if(typeof($('.addCover .myImg').attr('src'))!='undefined'){
        var addImg=$('.addCover .myImg').attr('src');
        $('#target').attr('src',addImg);
        preImg(addImg);
    }
    $('.dialogCover .selImgBtn').click(function () {
        openBrowseImg()
    });
    $('.dialogCover .sureImgBtn').click(function () {
        if(typeof($('#target').attr('src'))=="undefined"){
            layer.msg('请选择图片进行裁剪');
            return;
        }
        var img = new Image();
        img.src = $('#target').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;

        var showWidth=$('#target').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#target').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.dialogCover .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.dialogCover .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.dialogCover .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.dialogCover .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;
        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.addCover .oneImgBox img').attr('src',base64);
            $('.dialogCover').remove();
            $('.addCover .oneImgBox .ImgBox').css({'display':'none'});
        }
    });
    $('.dialogCover .closeImgBtn').click(function () {
        $('.dialogCover').remove();
    });

    $('.dialogCover #file').change(function(){
        changeFileImg()
    });
    //1.
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("file").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("file").dispatchEvent(a);
        }
    }

    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("file");//根据id获取文件路径
        preImg(url);
        return false;
    }
    //3、将本地图片 显示到浏览器上
    function preImg(url) {
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }
        initTargetImg();
        var image = document.getElementById('target');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;
                if(realWidth<750||realHeight<422){
                    $target.hide();
                    layer.msg('请选择尺寸不小于750*422px的图片')
                    return;
                }
                else{
                    initJcropImg();
                }
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $target.removeAttr("style");//清空上一次初始化设置的样式
        var showWidth=$('#target').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#target').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);
        //比例
        var minWidth=showWidth/(realWidth/750);
        var minHeight=minWidth/(750/422);
        $target.Jcrop({
            minSize:[minWidth,minHeight],
            aspectRatio: 750 / 422
        },function(){
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度
            jcrop_api = this;
        });
    }
    function initTargetImg(){
        $target.removeAttr("style");//清空上一次初始化设置的样式
        $target.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }
});

//补充封面图
$(document).on('click','.sup .oneImgBox',function () {
    var dialogCover='<div class="dialogCoverSup">'+
        '<button type="button" class="btn btn-primary selImgBtn">选择图片</button>' +
        '<button type="button" class="btn btn-success sureImgBtn">确定</button>' +
        '<button type="button" class="btn btn-warning closeImgBtn">取消</button>' +
        '<div class="head">' +
        '<img id="tarsup" />' +
        '<input type="file" id="filesup" style="display: none;"/>' +
        '</div>' +
        '</div>';
    $('html body').append(dialogCover);
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        $tarsup = $('#tarsup');

    if(typeof($('.supCover .myImg').attr('src'))!='undefined'){
        var addImg=$('.supCover .myImg').attr('src');
        $('#tarsup').attr('src',addImg);
        preImgSup(addImg);
    }

    $('.dialogCoverSup .selImgBtn').click(function(){
        openBrowseSup()
    });
    $('.dialogCoverSup .sureImgBtn').click(function(){
        if(typeof($('#tarsup').attr('src'))=="undefined"){
            layer.msg('请选择图片进行裁剪');
            return;
        }
        var img = new Image();
        img.src = $('#tarsup').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;

        var showWidth=$('#tarsup').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#tarsup').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.dialogCoverSup .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.dialogCoverSup .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.dialogCoverSup .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.dialogCoverSup .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;
        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.supCover .oneImgBox img').attr('src',base64);
            $('.dialogCoverSup').remove();
            $('.supCover .oneImgBox .ImgBox').css({'display':'none'});
        }
    });

    $('.dialogCoverSup #filesup').change(function(){
        changeFileSup()
    });
    $('.dialogCoverSup .closeImgBtn').click(function(){
        $('.dialogCoverSup').remove();
    });
//1、打开浏览器 onClick="openBrowse()" onchange="changeFile()" onClick="uploadFile()"
    function openBrowseSup(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("filesup").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("filesup").dispatchEvent(a);
        }
    }
    function getFileUrl(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
//选择文件事件
    function changeFileSup() {
        var url = getFileUrl("filesup");//根据id获取文件路径
        preImgSup(url);
        return false;
    }

//3、将本地图片 显示到浏览器上
    function preImgSup(url) {
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }
        //初始化图片
        initTargetSup();
        var image = document.getElementById('tarsup');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;
                if(realWidth<513||realHeight<513){
                    $tarsup.hide();
                    layer.msg('请选择尺寸不小于513*513px的图片')
                    return;
                }
                else{
                    initJcropSup();
                }
            };
            img.src = url;
        };
        image.src = url;
    }

//初始化Jcrop插件
    function initJcropSup(){
        $tarsup.removeAttr("style");//清空上一次初始化设置的样式
        var showWidth=$tarsup.css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        //比例
        var minWidth=showWidth/(realWidth/513);
        $tarsup.Jcrop({
            minSize:[minWidth,minWidth],
            aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度
            // 保存jcrop_api变量
            jcrop_api = this;
        });
    }
    function initTargetSup(){
        $tarsup.removeAttr("style");//清空上一次初始化设置的样式
        $tarsup.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }

});

//添加段落导语
$(document).on('click','.addIntBtn',function () {
    var intHtml='<div class="IntSingle">' +
        '<p class="IntHead">段落导语<span class="delBtn">X</span></p>' +
        '<div class="textareaBox">' +
        '<textarea class="form-control" rows="4" placeholder="请输入10～100个汉字的导语"></textarea>' +
        '<span class="des_tip">0/100</span>' +
        '</div>' +
        '</div>';
    $('#sortable').append(intHtml);
    if($('#isLocation').is(':checked')) {
        var len=$('#sortable .IntSingle').length;
        $('#sortable .IntSingle:last').attr('id',len);
        $("html,body").animate({scrollTop: $("#"+len).offset().top}, 500);
    }
});


$('html body').on('click','.IntSingle .delBtn',function () {
    var $IntSingle=$(this).parents('.IntSingle')
    layer.confirm('确定要删除改模块吗',function (index) {
        $IntSingle.remove();
        layer.close(index);
    },function (index) {
        layer.close(index);
    });

})
// 产品卡更换图片
$('html body').on('click','.IntSingle .change_img',function () {
    $imgSingle=$(this).siblings('.goods_img');
    var imgSrc=$(this).siblings('.goods_img').attr('src');
    var ul=$(this).parents('.IntSingle').find('.ul_img_box').html();
    var changeImgModel='<div class="changeImgModel">\n' +
        '\t\t\t<button type="button" class="btn btn-primary selImgBtn">选择图片</button><small style="margin: 0 10px">可选择以下图片或点击选择图片</small>\n' +
        '\t\t\t\t<button type="button" class="btn btn-success sureImgBtn">确定</button>\n' +
        '\t\t\t\t<button type="button" class="btn btn-warning closeImgBtn">取消</button><div style="margin-left: 40px">' +ul+'</div>'+
        '\t\t\t<div class="head">\n' +
        '\t\t\t\t<img src="'+imgSrc+'"  id="targetImg"/>\n' +
        '\t\t\t\t<input type="file" id="fileImg" style="display: none;"/>\n' +
        '\t\t\t</div>\n' +
        '\t\t</div>';
    $('html body').append(changeImgModel);
    $('.changeImgModel .img_ul').css({'margin-left':'-50px','height': '134px'});
    // 定义一些使用的变量
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    preImgImg(imgSrc);
    $('.changeImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.changeImgModel .sureImgBtn').click(function () {
        var img = new Image();
        img.src = $('#targetImg').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;
        if(img.src.indexOf('http')!=-1){
            img.crossOrigin = "Anonymous";
            img.src = $('#targetImg').attr('src');
        }

        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.changeImgModel .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.changeImgModel .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.changeImgModel .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.changeImgModel .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;

        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.changeImgModel').remove();
            $imgSingle.attr('src',base64);
        }
    });
    $('.changeImgModel .img_ul li').click(function () {
        var liSrc=$(this).find('img').attr('src');
        $('#targetImg').attr('src',liSrc);
        preImgImg(liSrc);
    })
    $('.changeImgModel .closeImgBtn').click(function () {
        $('.changeImgModel').remove();
    });

    $('.changeImgModel #fileImg').change(function(){
        changeFileImg()
    });
    //1、打开浏览器 onClick="openBrowse()" onchange="changeFile()" onClick="uploadFile()"
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }

    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }

    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;
                initJcropImg();
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度
            jcrop_api = this;
        });
    }
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }
})
//段落导语提示
$('html body').on('keyup','.IntSingle .textareaBox textarea',function () {
    var length = 100;
    var content_len = $(this).val().length;
    var in_len = length-content_len;
    $(this).siblings(".des_tip").html(content_len+'/100');
    if(content_len>length||content_len<10){
        $(this).siblings(".des_tip").addClass('warning');
    }
    else if(content_len<=length){
        $(this).siblings(".des_tip").removeClass('warning');
    }
});
$('html body').on('blur','.IntSingle .textareaBox textarea',function () {
    var length = 100;
    var content_len = $(this).val().length;
    var in_len = length-content_len;
    if(content_len!=''&&(content_len>length||content_len<10) ){
        layer.msg('段落描述长度需要在10-100字之间')
    }
});
//产品卡描述提示
$('html body').on('keyup','.IntSingle .goods_des',function () {
    var length = 100;
    var content_len = $(this).val().length;
    var in_len = length-content_len;
    $(this).siblings(".card_tip").html(content_len+'/100');
    if(content_len>length||content_len<10){
        $(this).siblings(".card_tip").addClass('warning');
    }
    else if(content_len<=length){
        $(this).siblings(".card_tip").removeClass('warning');
    }
});
$('html body').on('blur','.IntSingle .goods_des',function () {
    var length = 100;
    var content_len = $(this).val().length;
    var in_len = length-content_len;
    if(content_len!=''&&(content_len>length||content_len<10) ){
        layer.msg('产品描述长度需要在10-100字之间')
    }
});

//添加图片
$(document).on('click','.addImgBtn',function () {
    var addImgModel='<div class="addImgModel">\n' +
        '\t\t\t<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
        '\t\t\t<button type="button" class="btn btn-success sureImgBtn">确定</button>\n' +
        '\t\t\t<button type="button" class="btn btn-warning closeImgBtn">取消</button>\n' +
        '\t\t\t<div class="head">\n' +
        '\t\t\t\t<img id="targetImg" />\n' +
        '\t\t\t\t<input type="file" id="fileImg" style="display: none;"/>\n' +
        '\t\t\t</div>\n' +
        '\t\t</div>';
    $('html body').append(addImgModel);
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    $('.addImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.addImgModel .sureImgBtn').click(function () {
        if(typeof($('#targetImg').attr('src'))=="undefined"){
            layer.msg('请选择图片进行裁剪');
            return;
        }
        var img = new Image();
        img.src = $('#targetImg').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;

        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.addImgModel .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.addImgModel .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.addImgModel .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.addImgModel .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;

        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.addImgModel').remove();
            var imgBoxHtml='<div class="IntSingle">' +
                '<p class="IntHead">段落图片<span class="delBtn">X</span></p>' +
                '<div class="IntContent">' +
                '<img class="imgSingle" src=""/>' +
                '<button type="button" class="btn btn-warning changeImgBtn">更换图片</button>' +
                '</div>'+
                '</div>';
            $('#sortable').append(imgBoxHtml);
            $('.imgSingle:last').attr('src',base64);
            if($('#isLocation').is(':checked')) {
                var len=$('#sortable .IntSingle').length;
                $('#sortable .IntSingle:last').attr('id',len);
                $("html,body").animate({scrollTop: $("#"+len).offset().top}, 500);
            }
        }

    });
    $('.addImgModel .closeImgBtn').click(function () {
        $('.addImgModel').remove();
    });

    $('.addImgModel #fileImg').change(function(){
        changeFileImg()
    });

    //1、打开浏览器
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }
    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }

    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {

        console.log('url===' + url);
        //图片裁剪逻辑
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }

        //初始化图片
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;

                //获取图片真实高度之后
                initJcropImg();//初始化Jcrop插件
                //initCanvasImg();//初始化Canvas内容
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            //onChange: updatePreviewImg,
            //onSelect: updatePreviewImg
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度

            // 保存jcrop_api变量
            jcrop_api = this;

        });
    }

    //初始化预览div内容
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }
})
$('html body').on('click','.IntSingle .changeImgBtnBefore',function () {
    $imgSingle=$(this).siblings('.imgSingle');
    var imgSrc=$(this).siblings('.imgSingle').attr('src');
    var changeImgModel='<div class="changeImgModel">\n' +
        '\t\t\t<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
        '\t\t\t<button type="button" class="btn btn-success sureImgBtn">确定</button>\n' +
        '\t\t\t<button type="button" class="btn btn-warning closeImgBtn">取消</button>\n' +
        '\t\t\t<div class="head">\n' +
        '\t\t\t\t<img id="targetImg" src="'+imgSrc+'"/>\n' +
        '\t\t\t\t<input type="file" id="fileImg" style="display: none;"/>\n' +
        '\t\t\t</div>\n' +
        '\t\t</div>';
    $('html body').append(changeImgModel);
    // 定义一些使用的变量
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        $targetImg = $('#targetImg');
    preImgImg(imgSrc);
    $('.changeImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.changeImgModel .sureImgBtn').click(function () {
        var img = new Image();
        img.src = $('#targetImg').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;

        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.changeImgModel .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.changeImgModel .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.changeImgModel .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.changeImgModel .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;
        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.changeImgModel').remove();
            $imgSingle.attr('src',base64);
        }
    });
    $('.changeImgModel .closeImgBtn').click(function () {
        $('.changeImgModel').remove();
    });

    $('.changeImgModel #fileImg').change(function(){
        changeFileImg()
    });
    //1、打开浏览器
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }
    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }
    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }
        //初始化图片
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;
                //获取图片真实高度之后
                initJcropImg();//初始化Jcrop插件
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度
            jcrop_api = this;
        });
    }
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }

});

//添加宝贝--专辑
$(document).on('click','.addBaby',function () {
    var imgList=["https://img.alicdn.com/imgextra/i1/1112588309/TB24Znsh.UIL1JjSZFrXXb3xFXa_!!1112588309.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/https://img.alicdn.com/imgextra/i3/3175436648/O1CN011yypVZH8Ez1AlGN_!!3175436648.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/https://img.alicdn.com/imgextra/i2/3175436648/O1CN011yypVP4pLVeAV7M_!!3175436648.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/https://img.alicdn.com/imgextra/i4/3175436648/O1CN011yypVPWDJRtclGe_!!3175436648.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/i1/1112588309/TB2OlzLgJzJ8KJjSspkXXbF7VXa_!!1112588309.jpg_430x430q90.jpg"
    ];
    var imgRandom=parseInt(Math.random()*5);
    var goodsLink="https://detail.tmall.com/item.htm?id=568792074762&ali_trackid=2:mm_119430167_19686107_67938864:1539938240_260_873074974&track_params=null&spm=a21ye.index.richtext_item.d568792074762&pg1stepk=ucm:204019996122_2900201289_{%22common_content_page%22:daren}";

    var intHtml='<div class="IntSingle">' +
        '<p class="IntHead">产品卡<span class="delBtn">X</span></p>' +
        '<div style="width: 100%">' +
        '<div class="div_left"><img src="'+imgList[imgRandom]+'" class="goods_img"/><span class="change_img">更换图片</span></div>'+
        '<div class="div_center">' +
        '<div><a href="'+goodsLink+'" target="_blank">2018新款秋冬礼服吊带裙女小黑裙宴会聚会连衣裙气质修身短款裙</a></div>'+
        '<div><span>￥</span><span class="price">158</span></div>'+
        '<div><span class="shop_name">梦梦家旗舰店</span></div>'+
        '</div>'+
        '<div class="div_right">' +
        '<textarea class="goods_des" rows="4" placeholder="请输入10-100字导语"></textarea>' +
        '<span class="card_tip">0/100</span>' +
        '</div>'+
        '</div>'+
        '</div>';

    $('#sortable').append(intHtml);

    if($('#isLocation').is(':checked')) {
        var len=$('#sortable .IntSingle').length;
        $('#sortable .IntSingle:last').attr('id',len);
        $("html,body").animate({scrollTop: $("#"+len).offset().top}, 500);
    }
});

//添加宝贝--图集
$(document).on('click','.addBabyAtlas',function () {
    var imgList=["https://img.alicdn.com/imgextra/i1/1112588309/TB24Znsh.UIL1JjSZFrXXb3xFXa_!!1112588309.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/https://img.alicdn.com/imgextra/i3/3175436648/O1CN011yypVZH8Ez1AlGN_!!3175436648.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/https://img.alicdn.com/imgextra/i2/3175436648/O1CN011yypVP4pLVeAV7M_!!3175436648.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/https://img.alicdn.com/imgextra/i4/3175436648/O1CN011yypVPWDJRtclGe_!!3175436648.jpg_430x430q90.jpg",
        "https://img.alicdn.com/imgextra/i1/1112588309/TB2OlzLgJzJ8KJjSspkXXbF7VXa_!!1112588309.jpg_430x430q90.jpg"
    ];
    var imgRandom=parseInt(Math.random()*5);
    var goodsLink="https://detail.tmall.com/item.htm?id=568792074762&ali_trackid=2:mm_119430167_19686107_67938864:1539938240_260_873074974&track_params=null&spm=a21ye.index.richtext_item.d568792074762&pg1stepk=ucm:204019996122_2900201289_{%22common_content_page%22:daren}";
    var intHtml='<div class="atlasSingle">' +
        // '<p class="IntHead">产品卡<span class="delAtlasBtn">X</span></p>' +

        '<span class="glyphicon glyphicon-remove delAtlasBtn"></span>' +
        '<div  class="atlas_img">' +
            '<div class="main_img">' +
                '<img src="'+imgList[imgRandom]+'"/>' +
            '</div>'+
            '<div class="vice_box">' +
                '<img class="vice_img" src="'+imgList[imgRandom]+'" class="goods_img"/>' +
                '<p class="vice_des">喜欢黑色的神秘和吞噬一切色彩强大气场...</p>' +
            '</div>'+
        '</div>' +
        '<div>' +
            '<p><a href="'+goodsLink+'" target="_blank">2018新款秋冬礼服吊带裙女小黑裙宴会聚会连衣裙气质修身短款裙</a></p>'+
            '<p class="vice_des">喜欢黑色的神秘和吞噬一切色彩强大气场，一席简约的赫本小黑裙足够你演绎出精彩的生活剧本！</p>' +
            '<p class="price">￥158</p>'+
            '<div><span class="shop_name">梦梦家旗舰店</span></div>'+
        '</div>'+

        '</div>';

    $('#sortable').append(intHtml);
});
//添加宝贝--删除图集
$(document).on('click','.atlasSingle .delAtlasBtn',function (){
    $(this).parents('.atlasSingle').remove();
})

//三图
$(document).on('click','.threeImgBox .sinImgBox',function () {
    var imgIndex=$('.threeImgBox .sinImgBox').index(this);
    console.log('第'+imgIndex+'张图')
    var threeImgModel='<div class="threeImgModel">\n' +
        '\t\t\t<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
        '\t\t\t<button type="button" class="btn btn-success sureImgBtn">确定</button>\n' +
        '\t\t\t<button type="button" class="btn btn-warning closeImgBtn">取消</button>\n' +
        '\t\t\t<div class="head">\n' +
        '\t\t\t\t<img id="targetImg" />\n' +
        '\t\t\t\t<input type="file" id="fileImg" style="display: none;"/>\n' +
        '\t\t\t</div>\n' +
        '\t\t</div>';
    $('html body').append(threeImgModel);
    // 定义一些使用的变量
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        $targetImg = $('#targetImg');

    if(typeof($('.threeImgBox .sinImgBox:eq('+imgIndex+') img').attr('src'))!="undefined"){
        var imgSrc=$('.threeImgBox .sinImgBox:eq('+imgIndex+') img').attr('src');
        $('#targetImg').attr('src',imgSrc);
        preImgImg(imgSrc);
    }
    $('.threeImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });
    $('.threeImgModel .sureImgBtn').click(function () {
        if(typeof($('#targetImg').attr('src'))=="undefined"){
            layer.msg('请选择图片进行裁剪');
            return;
        }
        var img = new Image();
        img.src = $('#targetImg').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;

        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.threeImgModel .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.threeImgModel .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.threeImgModel .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.threeImgModel .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;
        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.threeImgBox .sinImgBox:eq('+imgIndex+') .ImgBox').hide();
            $('.threeImgBox .sinImgBox:eq('+imgIndex+') img').attr('src',base64);
            $('.threeImgModel').remove();
        }
    });
    $('.threeImgModel .closeImgBtn').click(function () {
        $('.threeImgModel').remove();
    });

    $('.threeImgModel #fileImg').change(function(){
        changeFileImg()
    });
    //1.
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }

    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }
    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;
                if(realWidth<750||realHeight<422){
                    $targetImg.hide();
                    layer.msg('请选择尺寸不小于750*422px的图片')
                    return;
                }
                else{
                    initJcropImg();
                }
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);
        //比例
        var minWidth=showWidth/(realWidth/750);
        var minHeight=minWidth/(750/422);
        $targetImg.Jcrop({
            minSize:[minWidth,minHeight],
            aspectRatio: 750 / 422
        },function(){
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度
            jcrop_api = this;
        });
    }
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }
});

//预览
$(document).on('click','.previewBtn',function () {
    var obj;
    var title=$('#titleInp').val();
    var leads=$('.leads').val();
    var t_img;
    if($('.firstImg img').length>0){
        var firstImg=$('.firstImg img').attr('src');
        t_img='<img src="'+firstImg+'">';
    }

    if(title==''){
        layer.msg('请填写标题');
        return;
    }
    else if (title.length<4){
        layer.msg('标题不能少于4个字');
        return;
    }
    else if (title.length>19){
        layer.msg('标题不能多于19个字');
        return;
    }

    if(leads==''){
        layer.msg('请填写导语');
        return;
    }
    else if (leads.length<10){
        layer.msg('导语不能少于10个字');
        return;
    }
    else if (leads.length>100){
        layer.msg('导语不能多于100个字');
        return;
    }
    var len=$('#sortable .IntSingle').length;
    var content=[];
    for (var i=0;i<len;i++){
        var single;
        var addType=$('#sortable .IntSingle:eq('+i+') .IntHead').text();
        if(addType.indexOf('图片')!=-1){
            single={
                type:2,
                img:$('#sortable .IntSingle:eq('+i+') img').attr('src'),
                describe:'',
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('导语')!=-1){
            var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            if(describe==''){
                layer.msg('请填写段落导语');
            }
            else if (describe.length<10){
                layer.msg('段落导语不能少于10个字');
            }
            else if (describe.length>100){
                layer.msg('段落导语不能多于100个字');
            }
            single={
                type:1,
                img:'',
                describe:describe,
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('产品卡')!=-1){
            // var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            // if(describe!=''&&(describe.length<10||describe.length>100)){
            //     layer.msg('产品卡的描述必须在10-100字之间');
            // }
            single={
                type:4,
                img:$('#sortable .IntSingle:eq('+i+') .div_left img').attr('src'),
                describe:'',
                // describe:$('#sortable .IntSingle:eq('+i+') .div_right textarea').val(),
                link:$('#sortable .IntSingle:eq('+i+') a').attr('href'),
                price:$('#sortable .IntSingle:eq('+i+') .price').text(),
                goods_name:$('#sortable .IntSingle:eq('+i+') a').text(),
                shop_name:$('#sortable .IntSingle:eq('+i+') .shop_name').text()
            }
        }
        content.push(single);
    }
    var article_content='';
    for (var i=0;i<len;i++){

        if(content[i].type==2){
            article_content+= '<div class="article_img">' +
                '<img  class="tt-img" src="'+content[i].img+'" />' +
                '</div>' ;
        }
        else if(content[i].type==1){
            article_content+= '<div class="article_des">' +
                '<div class="tt-des">'+content[i].describe+'</div>' +
                '</div>' ;
        }
        else if(content[i].type==4){
            article_content+= '<div class="article_card">' +
                '<div class="tt-card">'+
                '<div class="tt-card-left">'+
                '<img  class="tt-img" src="'+content[i].img+'" />' +
                '</div>' +
                '<div class="tt-card-right">'+
                '<a class="tt-link" href="'+content[i].link+'" target="_blank">'+content[i].goods_name+ '</a>' +
                '<p class="tt-price" >￥'+content[i].price+ '</p>' +
                '</div>' +
                '</div>' +
                '</div>' ;
        }
    }

    var img = '<div class="phone-preview">' +
        '<div class="preview-article-content">' +
        '<div class="tt-title">'+title+'</div>' +
        '<div class="tt-first-img">'+t_img+'</div>' +
        '<div class="tt-leads">'+leads+'</div>' +
        '<div class="tt-content">'+article_content+'</div>' +
        '</div>'+
        '</div>' ;


    layer.open({
        type: 1,
        title: false, //不显示标题
        area:['auto','auto'],
        shade: [0.8, '#393D49'],
        shadeClose:true,
        content: img, //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
        cancel: function () {
            //layer.msg('图片查看结束！', { time: 5000, icon: 6 });
        }
    });
    // layui-layer
    $('.phone-preview').parents('.layui-layer').css({'background-color':'transparent','box-shadow':'none'})
})

//发布
$(document).on('click','.publishBtn',function () {
    var $publishBtn=$(this);
    $(this).css({'cursor':'not-allowed'});
    var obj;
    var title=$('#titleInp').val();
    var leads=$('.leads').val();
    if(title==''){
        layer.msg('请填写标题');
        return;
    }
    else if (title.length<4){
        layer.msg('标题不能少于4个字');
        return;
    }
    else if (title.length>19){
        layer.msg('标题不能多于19个字');
        return;
    }

    if(leads==''){
        layer.msg('请填写导语');
        return;
    }
    else if (leads.length<10){
        layer.msg('导语不能少于10个字');
        return;
    }
    else if (leads.length>100){
        layer.msg('导语不能多于100个字');
        return;
    }
    var len=$('#sortable .IntSingle').length;
    var content=[];
    for (var i=0;i<len;i++){
        var single;
        var addType=$('#sortable .IntSingle:eq('+i+') .IntHead').text();
        if(addType.indexOf('段落图片')!=-1){
            single={
                type:2,
                img:$('#sortable .IntSingle:eq('+i+') .imgSingle').attr('src'),
                describe:'',
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('段落导语')!=-1){
            var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            if(describe==''){
                layer.msg('请填写段落导语');
                return;
            }
            else if (describe.length<10){
                layer.msg('段落导语不能少于10个字');
                return;
            }
            else if (describe.length>100){
                layer.msg('段落导语不能多于100个字');
                return;
            }
            single={
                type:1,
                img:'',
                describe:describe,
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('产品卡')!=-1){
            var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            if(describe!=''&&(describe.length<10||describe.length>100)){
                layer.msg('产品卡的描述必须在10-100字之间');
            }
            single={
                type:4,
                img:$('#sortable .IntSingle:eq('+i+') .div_left img').attr('src'),
                describe:$('#sortable .IntSingle:eq('+i+') .div_right textarea').val(),
                link:$('#sortable .IntSingle:eq('+i+') a').attr('href'),
                price:$('#sortable .IntSingle:eq('+i+') .price').text(),
                goods_name:$('#sortable .IntSingle:eq('+i+') a').text(),
                shop_name:$('#sortable .IntSingle:eq('+i+') .shop_name').text()
            }
        }
        content.push(single);
    }
    var coverType=$("input[type='radio']:checked").parents('label').text().trim();
    var cover=[];
    if(coverType=='单图'){
        coverType=1;
        if(typeof($('.oneImgBox img').attr("src"))=="undefined"){
            layer.msg('请设置封面');
            return;
        }
        var coverSrc=$('.oneImgBox img').attr('src');
        cover.push(coverSrc);
    }
    else{
        coverType=2;
        for (var i=0;i<3;i++){
            if(typeof($('.threeImgBox .sinImgBox:eq('+i+') img').attr("src"))=="undefined"){
                layer.msg('请设置封面');
                return;
            }
            var coverSrc=$('.threeImgBox .sinImgBox:eq('+i+') img').attr('src');
            cover.push(coverSrc);
        }
    }
    if(typeof($('.supCover img').attr("src"))=="undefined"){
        layer.msg('请设置补充封面');
        return;
    }
    var supCover=$('.supCover img').attr('src');
    var people='';
    var peopleOne=$(".peopleOne option:selected").text();
    var peopleTwo=$(".peopleTwo option:selected").text();
    people+=peopleOne+','+peopleTwo;

    var articleClass=[];
    var classObj;
    var articleType=$('.classParent').text();
    var articleTypeWords=[];
    var labelLen=$('.classChild label').length;
    for (var i=0;i<labelLen;i++){
        if($('.classChild label:eq('+i+') input').is(':checked')) {
            var word=$('.classChild label:eq('+i+')').text();
            articleTypeWords.push(word);
        }
    }
    classObj={
        articleType:articleType,
        articleTypeWords:articleTypeWords
    };
    articleClass.push(classObj);
    if(articleTypeWords.length==0){
        layer.msg('请选择分类');
        return;
    }
    obj={
        // 10是发布  0是存草稿
        saveType:10,
        title:title,
        leads:leads,
        content:content,
        coverType:coverType,
        cover:cover,
        supCover:supCover,
        people:people,
        articleClass:articleClass
    };

    $.post(
        '/admin/article/save_article',
        {
            data:JSON.stringify(obj),
            _token :  $("input[name='_token']").val()
        },
        function(res) {
            var res=JSON.parse(res);
            if(res.status==0){
                layer.msg('发布成功');
                window.location.href='index';
            }
            else{
                layer.msg('发布失败');
            }
            setTimeout(function () {
                $publishBtn.css({'cursor':'pointer'});
            },5000)
        }
    )
});

//存草稿
$(document).on('click','.draftBtn',function () {
    var $draftBtn=$(this);
    $(this).css({'cursor':'not-allowed'});
    var obj;
    var title=$('#titleInp').val();
    var leads=$('.leads').val();
    if(title==''){
        layer.msg('请填写标题');
        return;
    }
    else if (title.length<4){
        layer.msg('标题不能少于4个字');
        return;
    }
    else if (title.length>19){
        layer.msg('标题不能多于19个字');
        return;
    }

    if(leads==''){
        layer.msg('请填写导语');
        return;
    }
    else if (leads.length<10){
        layer.msg('导语不能少于10个字');
        return;
    }
    else if (leads.length>100){
        layer.msg('导语不能多于100个字');
        return;
    }
    var len=$('#sortable .IntSingle').length;
    var content=[];
    for (var i=0;i<len;i++){
        var single;
        var addType=$('#sortable .IntSingle:eq('+i+') .IntHead').text();
        if(addType.indexOf('段落图片')!=-1){
            single={
                type:2,
                img:$('#sortable .IntSingle:eq('+i+') .imgSingle').attr('src'),
                describe:'',
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('段落导语')!=-1){
            var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            if(describe==''){
                layer.msg('请填写段落导语');
                return;
            }
            else if (describe.length<10){
                layer.msg('段落导语不能少于10个字');
                return;
            }
            else if (describe.length>100){
                layer.msg('段落导语不能多于100个字');
                return;
            }
            single={
                type:1,
                img:'',
                describe:describe,
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('产品卡')!=-1){
            var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            if(describe!=''&&(describe.length<10||describe.length>100)){
                layer.msg('产品卡的描述必须在10-100字之间');
            }
            single={
                type:4,
                img:$('#sortable .IntSingle:eq('+i+') .div_left img').attr('src'),
                describe:$('#sortable .IntSingle:eq('+i+') .div_right textarea').val(),
                link:$('#sortable .IntSingle:eq('+i+') a').attr('href'),
                price:$('#sortable .IntSingle:eq('+i+') .price').text(),
                goods_name:$('#sortable .IntSingle:eq('+i+') a').text(),
                shop_name:$('#sortable .IntSingle:eq('+i+') .shop_name').text()
            }
        }
        content.push(single);
    }
    var coverType=$("input[type='radio']:checked").parents('label').text().trim();
    var cover=[];
    if(coverType=='单图'){
        coverType=1;
        if(typeof($('.oneImgBox img').attr("src"))=="undefined"){
            layer.msg('请设置封面');
            return;
        }
        var coverSrc=$('.oneImgBox img').attr('src');
        cover.push(coverSrc);
    }
    else{
        coverType=2;
        for (var i=0;i<3;i++){
            if(typeof($('.threeImgBox .sinImgBox:eq('+i+') img').attr("src"))=="undefined"){
                layer.msg('请设置封面');
                return;
            }
            var coverSrc=$('.threeImgBox .sinImgBox:eq('+i+') img').attr('src');
            cover.push(coverSrc);
        }
    }
    if(typeof($('.supCover img').attr("src"))=="undefined"){
        layer.msg('请设置补充封面');
        return;
    }
    var supCover=$('.supCover img').attr('src');
    var people='';
    var peopleOne=$(".peopleOne option:selected").text();
    var peopleTwo=$(".peopleTwo option:selected").text();
    people+=peopleOne+','+peopleTwo;

    var articleClass=[];
    var classObj;
    var articleType=$('.classParent').text();
    var articleTypeWords=[];
    var labelLen=$('.classChild label').length;
    for (var i=0;i<labelLen;i++){
        if($('.classChild label:eq('+i+') input').is(':checked')) {
            var word=$('.classChild label:eq('+i+')').text();
            articleTypeWords.push(word);
        }
    }
    classObj={
        articleType:articleType,
        articleTypeWords:articleTypeWords
    };
    articleClass.push(classObj);
    if(articleTypeWords.length==0){
        layer.msg('请选择分类');
        return;
    }
    obj={
        // 10是发布  0是存草稿
        saveType:0,
        title:title,
        leads:leads,
        content:content,
        coverType:coverType,
        cover:cover,
        supCover:supCover,
        people:people,
        articleClass:articleClass
    };

    $.post(
        '/admin/article/save_article',
        {
            data:JSON.stringify(obj),
            _token :  $("input[name='_token']").val()
        },
        function(res) {
            var res=JSON.parse(res);
            if(res.status==0){
                layer.msg('存草稿成功');
                window.location.href='index';
            }
            else{
                layer.msg('存草稿失败');
            }
            setTimeout(function () {
                $draftBtn.css({'cursor':'pointer'});
            },5000)
        }
    )
})

//标题提示
$(document).on('keyup',"#titleInp",function(){
    var length = 19;
    var content_len = $("#titleInp").val().length;
    var in_len = length-content_len;
    $(".title_tip").html(content_len+'/19');
    if(content_len>length||content_len<4){
        $(".title_tip").addClass('warning');
    }
    else if(content_len<=length){
        $(".title_tip").removeClass('warning');
    }
});
$(document).on('blur',"#titleInp",function(){
    var length = 19;
    var content_len = $("#titleInp").val().length;
    var in_len = length-content_len;
    if(content_len!=''&&(content_len>length||content_len<4) ){
        layer.msg('标题长度需要在4-19字之间')
    }
});

//导语提示
$(document).on('keyup',".leads",function(){
    var length = 100;
    var content_len = $(".leads").val().length;
    var in_len = length-content_len;
    $(".leads_tip").html(content_len+'/100');
    if(content_len>length||content_len<10){
        $(".leads_tip").addClass('warning');
    }
    else if(content_len<=length){
        $(".leads_tip").removeClass('warning');
    }
});
$(document).on('blur',".leads",function(){
    var length = 100;
    var content_len = $(".leads").val().length;
    var in_len = length-content_len;
    if(content_len!=''&&(content_len>length||content_len<10) ){
        layer.msg('导语长度需要在10-100字之间')
    }
});

// 生成模板
$('html body').on('click','.modelBtn',function () {
    var line;
    if($('.lineBox img').attr('src')!='undefine'){
        var lineSrc=$('.lineBox img').attr('src');
        line='<img class="lineImgSin" src="'+lineSrc+'">';
    }
    else{
        line='<img class="lineImgSin">';
    }

    var productNum=$('.productNum').val();
    var modelNum=productNum/2;
    var html='';
    for (var i=0;i<modelNum;i++){
        html+=
            '<div class="IntSingle">' +
            '<p class="IntHead">分割线图片<span class="delBtn">X</span></p>' +
            '<div class="IntContent">' +line+
            '</div>'+
            '</div>'+
            '<div class="IntSingle">' +
            '<p class="IntHead">段落图片<span class="delBtn">X</span></p>' +
            '<div class="IntContent">' +
            '<button type="button" class="btn btn-primary cardAddImgBtn">添加图片</button>' +
            '</div>'+
            '</div>'+
            '<div class="IntSingle">' +
            '<p class="IntHead">段落图片<span class="delBtn">X</span></p>' +
            '<div class="IntContent">' +
            '<button type="button" class="btn btn-primary cardAddImgBtn">添加图片</button>' +
            '</div>'+
            '</div>'+
            '<div class="IntSingle">' +
            '<p class="IntHead">段落导语<span class="delBtn">X</span></p>' +
            '<div class="textareaBox">' +
            '<textarea class="form-control" rows="4" placeholder="请输入10～100个汉字的导语"></textarea>' +
            '<span class="des_tip">0/100</span>' +
            '</div>' +
            '</div>'+
            '<div class="IntSingle">' +
            '<p class="IntHead">产品卡<span class="delBtn">X</span></p>' +
            '<div class="IntContent">' +
            '<button type="button" class="btn btn-primary cardAddBabyBtn">添加宝贝</button>' +
            '</div>'+
            '</div>'+
            '<div class="IntSingle">' +
            '<p class="IntHead">产品卡<span class="delBtn">X</span></p>' +
            '<div class="IntContent">' +
            '<button type="button" class="btn btn-primary cardAddBabyBtn">添加宝贝</button>' +
            '</div>'+
            '</div>';
    }
    $('#sortable').append(html);
})

$(document).on('click','.cardAddImg',function () {
    var $IntContent=$(this).parents('.IntContent');
    var addImgModel='<div class="addImgModel">\n' +
        '\t\t\t<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
        '\t\t\t<button type="button" class="btn btn-success sureImgBtn">确定</button>\n' +
        '\t\t\t<button type="button" class="btn btn-warning closeImgBtn">取消</button>\n' +
        '\t\t\t<div class="head">\n' +
        '\t\t\t\t<img id="targetImg" />\n' +
        '\t\t\t\t<input type="file" id="fileImg" style="display: none;"/>\n' +
        '\t\t\t</div>\n' +
        '\t\t</div>';
    $('html body').append(addImgModel);
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    $('.addImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.addImgModel .sureImgBtn').click(function () {
        if(typeof($('#targetImg').attr('src'))=="undefined"){
            layer.msg('请选择图片进行裁剪');
            return;
        }
        var img = new Image();
        img.src = $('#targetImg').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;

        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.addImgModel .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.addImgModel .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.addImgModel .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.addImgModel .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;

        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.addImgModel').remove();
            var imgBoxHtml= '<img class="imgSingle" src="'+base64+'"/>' +
                            '<button type="button" class="btn btn-warning changeImgBtn">更换图片</button>';
            $IntContent.html(imgBoxHtml);
        }

    });
    $('.addImgModel .closeImgBtn').click(function () {
        $('.addImgModel').remove();
    });

    $('.addImgModel #fileImg').change(function(){
        changeFileImg()
    });

    //1、打开浏览器
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }
    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }

    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {

        console.log('url===' + url);
        //图片裁剪逻辑
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }

        //初始化图片
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;

                //获取图片真实高度之后
                initJcropImg();//初始化Jcrop插件
                //initCanvasImg();//初始化Canvas内容
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            //onChange: updatePreviewImg,
            //onSelect: updatePreviewImg
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度

            // 保存jcrop_api变量
            jcrop_api = this;

        });
    }

    //初始化预览div内容
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }
})

//添加段落图片
$(document).on('click','.cardAddImgBtn',function () {
    var $IntContent=$(this).parents('.IntContent');
    var imgSrc1='https://img.alicdn.com/imgextra/i1/3387110554/TB2B18EgBmWBuNkSndVXXcsApXa_!!3387110554.jpg';
    var imgSrc2='https://img.alicdn.com/imgextra/i1/3387110554/TB2hKyXoQKWBuNjy1zjXXcOypXa_!!3387110554.jpg';
    var imgSrc3='https://img.alicdn.com/imgextra/i3/3387110554/TB21vWJoFuWBuNjSspnXXX1NVXa_!!3387110554.jpg';
    var imgSrc4='https://img.alicdn.com/imgextra/i3/3727709033/O1CN012GbA7r3L99G7n9t_!!3727709033.jpg';
    var imgSrc5='https://img.alicdn.com/imgextra/i1/3727709033/TB2ky0vcXOWBuNjy0FiXXXFxVXa_!!3727709033.jpg';
    var table='<table class="table table-bordered imgTable">'+
                    // '<caption>边框表格布局</caption>'+
                    '<thead>'+
                        '<tr>'+
                            '<th>选择</th>'+
                            '<th>类型</th>'+
                            '<th>内容</th>'+
                            '<th>分类</th>'+
                            '<th>来源</th>'+
                            '<th>关键字</th>'+
                            '<th>修改时间</th>'+
                        '</tr>'+
                    '</thead>'+
                    '<tbody>'+
                        '<tr>'+
                            '<td><input type="checkbox" name="imgCheck"></td>'+
                            '<td>图片</td>'+
                            '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc1+'"></div></td>'+
                            '<td>服饰内衣</td>'+
                            '<td>淘宝</td>'+
                            '<td>女半身裙</td>'+
                            '<td>2018-08-27 06:10:37</td>'+
                        '</tr>'+
                        '<tr>'+
                        '<td><input type="checkbox" name="imgCheck"></td>'+
                        '<td>图片</td>'+
                        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc2+'"></div></td>'+
                        '<td>服饰内衣</td>'+
                        '<td>淘宝</td>'+
                        '<td>女半身裙</td>'+
                        '<td>2018-08-27 06:10:37</td>'+
                        '</tr>'+
                        '<tr>'+
                        '<td><input type="checkbox" name="imgCheck"></td>'+
                        '<td>图片</td>'+
                        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc5+'"></div></td>'+
                        '<td>服饰内衣</td>'+
                        '<td>淘宝</td>'+
                        '<td>女半身裙</td>'+
                        '<td>2018-08-27 06:10:37</td>'+
                        '</tr>'+
                        '<tr>'+
                        '<td><input type="checkbox" name="imgCheck"></td>'+
                        '<td>图片</td>'+
                        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc2+'"></div></td>'+
                        '<td>服饰内衣</td>'+
                        '<td>淘宝</td>'+
                        '<td>女半身裙</td>'+
                        '<td>2018-08-27 06:10:37</td>'+
                        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox"  name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc3+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc4+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc5+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc3+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
                    '</tbody>'+
                '</table>';
    var content='<section class="content">'+
                    '<div class="box" style="border:0 none;">'+
                        '<ul id="imgTab" class="nav nav-tabs">'+
                            '<li class="active"><a href="#selectImg" data-toggle="tab">选择图片</a></li>'+
                            '<li><a href="#uploadImg" data-toggle="tab">上传图片</a></li>'+
                            '<li><a href="#pieceImg" data-toggle="tab">图片拼合</a></li>'+
                        '</ul>'+
                        '<div class="box-body">'+
                            '<div id="imgTab" class="tab-content">'+
                                '<div class="tab-pane fade in active" id="selectImg">'+
                                    '<div class="imgSource">'+
                                        '<span>来源:</span>'+
                                        '<select class="selectStyle">'+
                                            '<option>淘宝</option>'+
                                            '<option>今日头条</option>'+
                                            '<option>裁剪图</option>'+
                                            '<option>其他</option>'+
                                        '</select>'+
                                        '<span style="margin-left: 16px">分类:</span>'+
                                        '<select class="selectStyle">'+
                                            '<option>手机</option>'+
                                            '<option>数码</option>'+
                                            '<option>电脑办公</option>'+
                                            '<option>家用电器</option>'+
                                            '<option>服饰内衣</option>'+
                                        '</select>'+
                                        '<select class="selectStyle">'+
                                            '<option>手机</option>'+
                                            '<option>数码</option>'+
                                            '<option>电脑办公</option>'+
                                            '<option>家用电器</option>'+
                                            '<option>服饰内衣</option>'+
                                        '</select>'+
                                        '<select class="selectStyle">'+
                                            '<option>手机</option>'+
                                            '<option>数码</option>'+
                                            '<option>电脑办公</option>'+
                                            '<option>家用电器</option>'+
                                            '<option>服饰内衣</option>'+
                                        '</select>'+
                                        '<span style="margin-left: 16px">关键字:</span>'+
                                        '<select class="selectStyle">'+
                                        '<option>手机</option>'+
                                        '<option>数码</option>'+
                                        '</select>'+
                                        '<input type="text" placeholder="请输入关键字/内容" class="inputStyle">'+
                                        '<button type="button" class="btn btn-primary btn-sm getImgBtn" style="margin-left: 16px">筛选</button>'+
                                    '</div>'+table+
                                '</div>'+
                                '<div class="tab-pane fade" id="uploadImg">'+
                                    '<div class="uploadImgModel">' +
                                        '<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
                                        '<div class="head">\n' +
                                            '<img id="targetImg" />\n' +
                                            '<input type="file" id="fileImg" style="display: none;"/>\n' +
                                        '</div>' +
                                    '</div>'+
                                '</div>'+
                                '<div class="tab-pane fade" id="pieceImg">'+
                                    '<div class="pieceImgModel" id="imgsortable">' +
                                        '<div class="pieceImgBox">' +
                                            '<img id="pieceTargetImg1" />' +
                                            '<span class="upImg1">上传图片</span>'+
                                            '<input type="file" id="pieceFileImg1" style="display: none;"/>' +
                                        '</div>'+
                                        '<div class="pieceImgBox">' +
                                        '<img id="pieceTargetImg2" />' +
                                        '<span class="upImg2">上传图片</span>'+
                                        '<input type="file" id="pieceFileImg2" style="display: none;"/>' +
                                        '</div>'+
                                        '<div class="pieceImgBox">' +
                                        '<img id="pieceTargetImg3" />' +
                                        '<span class="upImg3">上传图片</span>'+
                                        '<input type="file" id="pieceFileImg3" style="display: none;"/>' +
                                        '</div>'+
                                        '<button type="button" class="btn btn-primary pImgBtn">拼合</button>\n' +
                                        '<div class="previewBox">' +
                                            '<img id="previewImg" />' +
                                        '</div>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                        '</div>'+
                    '</div>';
    layer.open({
        type: 1,
        title: "添加图片", //不显示标题
        area:['80%','100%'],
        shade: [0.8, '#393D49'],
        shadeClose:false,
        content: content,
        closeBtn:0,
        btn: ['确认','取消'],
        yes:function(index, layero){
            if($('#imgTab li:eq(0)').hasClass('active')) {
                var imgSrc;
                var checkedLen=$('input[name="imgCheck"]:checked').length;
                if(checkedLen==1){
                    imgSrc=$('input[name="imgCheck"]:checked').parents('tr').find('img').attr('src');
                    var imgBoxHtml = '<img class="imgSingle" src="' + imgSrc + '"/>' +
                        // '<button type="button" class="btn btn-info changeImgBtn">更换图片</button>' +
                        '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-pencil"></span>' +
                        '</button>'+
                        '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-scissors"></span>' +
                        '</button>';
                    $IntContent.html(imgBoxHtml);
                }
                else{
                    var imgList=[];
                    for(var i=0;i<checkedLen;i++){
                        $('input[name="imgCheck"]:checked').eq(i).parents('tr').find('img').attr('id','checkedImg'+i);
                        var img=$('input[name="imgCheck"]:checked').eq(i).parents('tr').find('img').attr('src');
                        imgList.push(img);
                    }
                    if(imgList.length==2){
                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                // console.log(imgSrc)
                                var imgBoxHtml = '<img class="imgSingle" src="' + imgSrc + '"/>' +
                                    '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-pencil"></span>' +
                                    '</button>'+
                                    '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-scissors"></span>' +
                                    '</button>';
                                $IntContent.html(imgBoxHtml);
                            }
                        }

                    }
                    if(imgList.length==3){

                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img3Width=document.getElementById('checkedImg2').naturalWidth;
                        var img3Height=document.getElementById('checkedImg2').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var img3 = new Image();
                        img3.crossOrigin = "Anonymous";
                        img3.src = $('#checkedImg2').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width+img3Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                // console.log(imgSrc)
                                var imgBoxHtml = '<img class="imgSingle" src="' + imgSrc + '"/>' +
                                    '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-pencil"></span>' +
                                    '</button>'+
                                    '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-scissors"></span>' +
                                    '</button>';
                                $IntContent.html(imgBoxHtml);

                            }
                        }

                    }
                }

            }
            else if($('#imgTab li:eq(1)').hasClass('active')) {
                if (typeof($('#targetImg').attr('src')) == "undefined") {
                    layer.msg('请选择图片进行裁剪');
                    return;
                }
                var img = new Image();
                img.src = $('#targetImg').attr('src');
                var realWidth = img.width;
                var realHeight = img.height;

                var showWidth = $('#targetImg').css('width');
                showWidth = showWidth.split('px');
                showWidth = parseInt(showWidth[0]);
                var showHeight = $('#targetImg').css('height');
                showHeight = showHeight.split('px');
                showHeight = parseInt(showHeight[0]);

                // 真实图片和显示图片的宽比  高比
                var ratio = realWidth / showWidth;

                var width = $('.uploadImgModel .jcrop-holder>div').css('width');
                if (width == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                width = width.split('px');
                width = parseInt(width[0]) * ratio;
                var height = $('.uploadImgModel .jcrop-holder>div').css('height');
                if (height == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                height = height.split('px');
                height = parseInt(height[0]) * ratio;
                var top = $('.uploadImgModel .jcrop-holder>div').css('top');
                top = top.split('px');
                top = 0 - parseInt(top[0]) * ratio;
                var left = $('.uploadImgModel .jcrop-holder>div').css('left');
                left = left.split('px');
                left = 0 - parseInt(left[0]) * ratio;
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext('2d');
                var base64;
                canvas.width = width;
                canvas.height = height;

                img.onload = function () {
                    this.width = realWidth;
                    this.height = realHeight;
                    ctx.drawImage(this, left, top, this.width, this.height);
                    base64 = canvas.toDataURL('image/jpeg', 1);
                    var imgBoxHtml = '<img class="imgSingle" src="' + base64 + '"/>' +
                        '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-pencil"></span>' +
                        '</button>'+
                        '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-scissors"></span>' +
                        '</button>';
                    $IntContent.html(imgBoxHtml);
                }
            }
            else if($('#imgTab li:eq(2)').hasClass('active')) {
                var base64=$('#previewImg').attr('src');
                var imgBoxHtml = '<img class="imgSingle" src="' + base64 + '"/>' +
                    '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                    '  <span class="glyphicon glyphicon-pencil"></span>' +
                    '</button>'+
                    '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                    '  <span class="glyphicon glyphicon-scissors"></span>' +
                    '</button>';
                $IntContent.html(imgBoxHtml);
            }
            layer.close(index);
        }
    });

    $( "#imgsortable" ).sortable();
    $( "#imgsortable" ).disableSelection();
    $('.pImgBtn').click(function () {
        for (var i=0;i<3;i++) {
            if($('.pieceImgBox:eq('+i+') img').attr('src')!='undefined'){
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+(i+1));
            }
            else{
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+0);
            }
        }
        var img1=$('#pieceTargetImg1').attr('src');
        var img2=$('#pieceTargetImg2').attr('src');
        var img3=$('#pieceTargetImg3').attr('src');
        var img1Width;
        var img1Height;
        var img2Width;
        var img2Height;
        var img3Width;
        var img3Height;
        if(img1!='undefined'){
            img1Width = document.getElementById('pieceTargetImg1').naturalWidth;
            img1Height = document.getElementById('pieceTargetImg1').naturalHeight;
        }
        if(img2!='undefined'){
            img2Width = document.getElementById('pieceTargetImg2').naturalWidth;
            img2Height = document.getElementById('pieceTargetImg2').naturalHeight;
        }
        if(img3!='undefined'){
            img3Width = document.getElementById('pieceTargetImg3').naturalWidth;
            img3Height = document.getElementById('pieceTargetImg3').naturalHeight;
        }
        var img1 = new Image();
        img1.src = $('#pieceTargetImg1').attr('src');
        var img2 = new Image();
        img2.src = $('#pieceTargetImg2').attr('src');
        var img3 = new Image();
        img3.src = $('#pieceTargetImg3').attr('src');

        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        if(img1!='undefined'&&img2!='undefined'&&img3!='undefined'){
            canvas.width = img1Width+img2Width+img3Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
            ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
        }
        else if (img1!='undefined'&&img2!='undefined'&&img3=='undefined') {
            canvas.width = img1Width+img2Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
        }
        base64 = canvas.toDataURL('image/jpeg', 1);
        // console.log(base64);
        $('#previewImg').attr('src',base64);
    });
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    $('.uploadImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.uploadImgModel #fileImg').change(function(){
        changeFileImg()
    });

    //1、打开浏览器
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }
    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }

    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {

        console.log('url===' + url);
        //图片裁剪逻辑
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }

        //初始化图片
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;

                //获取图片真实高度之后
                initJcropImg();//初始化Jcrop插件
                //initCanvasImg();//初始化Canvas内容
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            //onChange: updatePreviewImg,
            //onSelect: updatePreviewImg
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度

            // 保存jcrop_api变量
            jcrop_api = this;

        });
    }

    //初始化预览div内容
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }

    $('.pieceImgModel .upImg1').click(function () {
        openBrowseImg1()
    });

    $('.pieceImgModel #pieceFileImg1').change(function(){
        changeFileImg1()
    });
    function openBrowseImg1(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg1").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg1").dispatchEvent(a);
        }
    }
    function changeFileImg1() {
        var url = getFileUrlImg("pieceFileImg1");
        $('#pieceTargetImg1').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg2').click(function () {
        openBrowseImg2()
    });

    $('.pieceImgModel #pieceFileImg2').change(function(){
        changeFileImg2()
    });
    function openBrowseImg2(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg2").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg2").dispatchEvent(a);
        }
    }
    function changeFileImg2() {
        var url = getFileUrlImg("pieceFileImg2");
        $('#pieceTargetImg2').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg3').click(function () {
        openBrowseImg3()
    });

    $('.pieceImgModel #pieceFileImg3').change(function(){
        changeFileImg3()
    });
    function openBrowseImg3(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg3").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg3").dispatchEvent(a);
        }
    }
    function changeFileImg3() {
        var url = getFileUrlImg("pieceFileImg3");
        $('#pieceTargetImg3').attr('src',url);
        return false;
    }
})
//添加图片--更换图片
$(document).on('click','.IntSingle .changeImgBtn',function () {
    var $imgSingle=$(this).siblings('.imgSingle');
    var imgSrc1='https://img.alicdn.com/imgextra/i1/3387110554/TB2B18EgBmWBuNkSndVXXcsApXa_!!3387110554.jpg';
    var imgSrc2='https://img.alicdn.com/imgextra/i1/3387110554/TB2hKyXoQKWBuNjy1zjXXcOypXa_!!3387110554.jpg';
    var imgSrc3='https://img.alicdn.com/imgextra/i3/3387110554/TB21vWJoFuWBuNjSspnXXX1NVXa_!!3387110554.jpg';
    var imgSrc4='https://img.alicdn.com/imgextra/i3/3727709033/O1CN012GbA7r3L99G7n9t_!!3727709033.jpg';
    var imgSrc5='https://img.alicdn.com/imgextra/i1/3727709033/TB2ky0vcXOWBuNjy0FiXXXFxVXa_!!3727709033.jpg';
    var table='<table class="table table-bordered imgTable">'+
        // '<caption>边框表格布局</caption>'+
        '<thead>'+
        '<tr>'+
        '<th>选择</th>'+
        '<th>类型</th>'+
        '<th>内容</th>'+
        '<th>分类</th>'+
        '<th>来源</th>'+
        '<th>关键字</th>'+
        '<th>修改时间</th>'+
        '</tr>'+
        '</thead>'+
        '<tbody>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc1+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc2+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc3+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc4+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc5+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc1+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc2+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgCheck"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc3+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '</tbody>'+
        '</table>';
    var content='<section class="content">'+
        '<div class="box" style="border:0 none;">'+
        '<ul id="imgTab" class="nav nav-tabs">'+
        '<li class="active"><a href="#selectImg" data-toggle="tab">选择图片</a></li>'+
        '<li><a href="#uploadImg" data-toggle="tab">上传图片</a></li>'+
        '<li><a href="#pieceImg" data-toggle="tab">图片拼合</a></li>'+
        '</ul>'+
        '<div class="box-body">'+
        '<div id="imgTab" class="tab-content">'+
        '<div class="tab-pane fade in active" id="selectImg">'+
        '<div class="imgSource">'+
        '<span>来源:</span>'+
        '<select class="selectStyle">'+
        '<option>淘宝</option>'+
        '<option>今日头条</option>'+
        '<option>裁剪图</option>'+
        '<option>其他</option>'+
        '</select>'+
        '<span style="margin-left: 16px">分类:</span>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '<option>电脑办公</option>'+
        '<option>家用电器</option>'+
        '<option>服饰内衣</option>'+
        '</select>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '<option>电脑办公</option>'+
        '<option>家用电器</option>'+
        '<option>服饰内衣</option>'+
        '</select>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '<option>电脑办公</option>'+
        '<option>家用电器</option>'+
        '<option>服饰内衣</option>'+
        '</select>'+
        '<span style="margin-left: 16px">关键字:</span>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '</select>'+
        '<input type="text" placeholder="请输入关键字/内容" class="inputStyle">'+
        '<button type="button" class="btn btn-primary getImgBtn" style="margin-left: 16px">筛选</button>'+
        '</div>'+table+
        '</div>'+
        '<div class="tab-pane fade" id="uploadImg">'+
        '<div class="uploadImgModel">' +
        '<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
        '<div class="head">\n' +
        '<img id="targetImg" />\n' +
        '<input type="file" id="fileImg" style="display: none;"/>\n' +
        '</div>' +
        '</div>'+
        '</div>'+
        '<div class="tab-pane fade" id="pieceImg">'+
        '<div class="pieceImgModel" id="imgsortable">' +
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg1" />' +
        '<span class="upImg1">上传图片</span>'+
        '<input type="file" id="pieceFileImg1" style="display: none;"/>' +
        '</div>'+
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg2" />' +
        '<span class="upImg2">上传图片</span>'+
        '<input type="file" id="pieceFileImg2" style="display: none;"/>' +
        '</div>'+
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg3" />' +
        '<span class="upImg3">上传图片</span>'+
        '<input type="file" id="pieceFileImg3" style="display: none;"/>' +
        '</div>'+
        '<button type="button" class="btn btn-primary pImgBtn">拼合</button>\n' +
        '<div class="previewBox">' +
        '<img id="previewImg" />' +
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>';
    layer.open({
        type: 1,
        title: "添加图片", //不显示标题
        area:['80%','100%'],
        shade: [0.8, '#393D49'],
        shadeClose:false,
        content: content,
        closeBtn:0,
        btn: ['确认','取消'],
        yes:function(index, layero){
            if($('#imgTab li:eq(0)').hasClass('active')) {
                var imgSrc;
                var checkedLen=$('input[name="imgCheck"]:checked').length;
                if(checkedLen==1){
                    imgSrc=$('input[name="imgCheck"]:checked').parents('tr').find('img').attr('src');
                    $imgSingle.attr('src',imgSrc);
                }
                else{
                    var imgList=[];
                    for(var i=0;i<checkedLen;i++){
                        $('input[name="imgCheck"]:checked').eq(i).parents('tr').find('img').attr('id','checkedImg'+i);
                        var img=$('input[name="imgCheck"]:checked').eq(i).parents('tr').find('img').attr('src');
                        imgList.push(img);
                    }
                    if(imgList.length==2){
                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                // console.log(imgSrc)
                                $imgSingle.attr('src',imgSrc);
                            }
                        }
                    }
                    if(imgList.length==3){
                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img3Width=document.getElementById('checkedImg2').naturalWidth;
                        var img3Height=document.getElementById('checkedImg2').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var img3 = new Image();
                        img3.crossOrigin = "Anonymous";
                        img3.src = $('#checkedImg2').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width+img3Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                $imgSingle.attr('src',imgSrc);
                            }
                        }

                    }
                }

            }

            else if($('#imgTab li:eq(1)').hasClass('active')) {
                if (typeof($('#targetImg').attr('src')) == "undefined") {
                    layer.msg('请选择图片进行裁剪');
                    return;
                }
                var img = new Image();
                img.src = $('#targetImg').attr('src');
                var realWidth = img.width;
                var realHeight = img.height;

                var showWidth = $('#targetImg').css('width');
                showWidth = showWidth.split('px');
                showWidth = parseInt(showWidth[0]);
                var showHeight = $('#targetImg').css('height');
                showHeight = showHeight.split('px');
                showHeight = parseInt(showHeight[0]);

                // 真实图片和显示图片的宽比  高比
                var ratio = realWidth / showWidth;

                var width = $('.uploadImgModel .jcrop-holder>div').css('width');
                if (width == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                width = width.split('px');
                width = parseInt(width[0]) * ratio;
                var height = $('.uploadImgModel .jcrop-holder>div').css('height');
                if (height == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                height = height.split('px');
                height = parseInt(height[0]) * ratio;
                var top = $('.uploadImgModel .jcrop-holder>div').css('top');
                top = top.split('px');
                top = 0 - parseInt(top[0]) * ratio;
                var left = $('.uploadImgModel .jcrop-holder>div').css('left');
                left = left.split('px');
                left = 0 - parseInt(left[0]) * ratio;
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext('2d');
                var base64;
                canvas.width = width;
                canvas.height = height;

                img.onload = function () {
                    this.width = realWidth;
                    this.height = realHeight;
                    ctx.drawImage(this, left, top, this.width, this.height);
                    base64 = canvas.toDataURL('image/jpeg', 1);
                    $imgSingle.attr('src',base64);
                }
            }
            else if($('#imgTab li:eq(2)').hasClass('active')) {
                var base64=$('#previewImg').attr('src');
                $imgSingle.attr('src',base64);
            }
            layer.close(index);
        }
    });

    $( "#imgsortable" ).sortable();
    $( "#imgsortable" ).disableSelection();

    $('.pImgBtn').click(function () {
        for (var i=0;i<3;i++) {
            if($('.pieceImgBox:eq('+i+') img').attr('src')!='undefined'){
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+(i+1));
            }
            else{
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+0);
            }
        }
        var img1=$('#pieceTargetImg1').attr('src');
        var img2=$('#pieceTargetImg2').attr('src');
        var img3=$('#pieceTargetImg3').attr('src');
        var img1Width;
        var img1Height;
        var img2Width;
        var img2Height;
        var img3Width;
        var img3Height;
        if(img1!='undefined'){
            img1Width = document.getElementById('pieceTargetImg1').naturalWidth;
            img1Height = document.getElementById('pieceTargetImg1').naturalHeight;
        }
        if(img2!='undefined'){
            img2Width = document.getElementById('pieceTargetImg2').naturalWidth;
            img2Height = document.getElementById('pieceTargetImg2').naturalHeight;
        }
        if(img3!='undefined'){
            img3Width = document.getElementById('pieceTargetImg3').naturalWidth;
            img3Height = document.getElementById('pieceTargetImg3').naturalHeight;
        }
        var img1 = new Image();
        img1.src = $('#pieceTargetImg1').attr('src');
        var img2 = new Image();
        img2.src = $('#pieceTargetImg2').attr('src');
        var img3 = new Image();
        img3.src = $('#pieceTargetImg3').attr('src');

        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        if(img1!='undefined'&&img2!='undefined'&&img3!='undefined'){
            canvas.width = img1Width+img2Width+img3Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
            ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
        }
        else if (img1!='undefined'&&img2!='undefined'&&img3=='undefined') {
            canvas.width = img1Width+img2Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
        }
        base64 = canvas.toDataURL('image/jpeg', 1);
        // console.log(base64);
        $('#previewImg').attr('src',base64);
    });
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    $('.uploadImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.uploadImgModel #fileImg').change(function(){
        changeFileImg()
    });

    //1、打开浏览器
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }
    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }

    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {

        console.log('url===' + url);
        //图片裁剪逻辑
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }

        //初始化图片
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;

                //获取图片真实高度之后
                initJcropImg();//初始化Jcrop插件
                //initCanvasImg();//初始化Canvas内容
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            //onChange: updatePreviewImg,
            //onSelect: updatePreviewImg
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度

            // 保存jcrop_api变量
            jcrop_api = this;

        });
    }

    //初始化预览div内容
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }

    $('.pieceImgModel .upImg1').click(function () {
        openBrowseImg1()
    });

    $('.pieceImgModel #pieceFileImg1').change(function(){
        changeFileImg1()
    });
    function openBrowseImg1(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg1").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg1").dispatchEvent(a);
        }
    }
    function changeFileImg1() {
        var url = getFileUrlImg("pieceFileImg1");
        $('#pieceTargetImg1').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg2').click(function () {
        openBrowseImg2()
    });

    $('.pieceImgModel #pieceFileImg2').change(function(){
        changeFileImg2()
    });
    function openBrowseImg2(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg2").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg2").dispatchEvent(a);
        }
    }
    function changeFileImg2() {
        var url = getFileUrlImg("pieceFileImg2");
        $('#pieceTargetImg2').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg3').click(function () {
        openBrowseImg3()
    });

    $('.pieceImgModel #pieceFileImg3').change(function(){
        changeFileImg3()
    });
    function openBrowseImg3(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg3").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg3").dispatchEvent(a);
        }
    }
    function changeFileImg3() {
        var url = getFileUrlImg("pieceFileImg3");
        $('#pieceTargetImg3').attr('src',url);
        return false;
    }
})
//添加图片--裁剪图片
$(document).on('click','.IntSingle .cutImgBtn', function () {
    $imgSingle=$(this).siblings('.imgSingle');
    var imgSrc=$(this).siblings('.imgSingle').attr('src');
    var changeImgModel='<div class="changeImgModel">\n' +
        '\t\t\t\t<button type="button" class="btn btn-success sureImgBtn">确定</button>\n' +
        '\t\t\t\t<button type="button" class="btn btn-warning closeImgBtn">取消</button>'+
        '\t\t\t<div class="head">\n' +
        '\t\t\t\t<img src="'+imgSrc+'"  id="targetImg"/>\n' +
        '\t\t\t</div>\n' +
        '\t\t</div>';
    $('html body').append(changeImgModel);
    // 定义一些使用的变量
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    preImgImg(imgSrc);
    $('.changeImgModel .sureImgBtn').click(function () {
        var img = new Image();
        img.src = $('#targetImg').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;
        if(img.src.indexOf('http')!=-1){
            img.crossOrigin = "Anonymous";
            img.src = $('#targetImg').attr('src');
        }

        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.changeImgModel .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.changeImgModel .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.changeImgModel .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.changeImgModel .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;

        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            $('.changeImgModel').remove();
            $imgSingle.attr('src',base64);
        }
    });

    $('.changeImgModel .closeImgBtn').click(function () {
        $('.changeImgModel').remove();
    });
    function preImgImg(url) {
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;
                initJcropImg();
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度
            jcrop_api = this;
        });
    }
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }
})

//添加产品卡
$(document).on('click','.cardAddBabyBtn',function () {
    var $IntContent=$(this).parents('.IntContent');
    var url = '/admin/toutiao/get_goods_data_view';
    layer.open({
        type: 2,
        title: "添加宝贝",
        area:['80%','100%'],
        shade: [0.8, '#393D49'],
        shadeClose:false,
        content: url,
        closeBtn:0,
        btn: ['确认','取消'],
        yes:function(index, layero){
            var res = window["layui-layer-iframe" + index].callbackdata();
            var intHtml=
                '<div class="ul_img_box" style="display: none">'+res.img_box+'</div>'+
                '<div class="div_left"><img src="'+res.img+'" class="goods_img"/><span class="change_img">更换图片</span></div>'+
                '<div class="div_center">' +
                '<div><a href="'+res.url+'" target="_blank"><input type="hidden" class="goods_url" value="'+res.url+'"/><span class="title">'+res.title+'</span></a></div>'+
                '<div><span>￥</span><span class="price">'+res.price+'</span></div>'+
                '<div><span class="shop_name">'+res.shop_name+'</span></div>'+
                '</div>';
            $IntContent.html(intHtml);
            layer.close(index);
            if($('#isLocation').is(':checked')) {
                var len=$('#sortable .IntSingle').length;
                $('#sortable .IntSingle:last').attr('id',len);
                $("html,body").animate({scrollTop: $("#"+len).offset().top}, 500);
            }
            function getUrlBase64(url, ext, callback) {
                var canvas = document.createElement("canvas");   //创建canvas DOM元素
                var ctx = canvas.getContext("2d");
                var img = new Image;
                img.crossOrigin = 'Anonymous';
                img.src = url;
                img.onload = function () {
                    canvas.height = 733; //指定画板的高度,自定义
                    canvas.width = 733; //指定画板的宽度，自定义
                    ctx.drawImage(img, 0, 0, 733, 733); //参数可自定义
                    var dataURL = canvas.toDataURL("image/" + ext);
                    callback.call(this, dataURL); //回掉函数获取Base64编码
                    canvas = null;
                };
            }
        }
    });
});

//分割线
$('.lineBtn').click(function () {
    var content='<ul class="lineUl">'+
                    '<li><img src="http://p3a.pstatp.com/large/1f7a00011c5c6e4a259e"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7700011f8c20db3b29"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a0001206f6b39453a"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a0001208841c25f69"></li>'+

        '<li><img src="http://p3a.pstatp.com/large/1f7a000120a25e02c8b2"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a000120cc70fa8fdf"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7900011ff28caa449d"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f79000122e187d3f9a5"></li>'+

        '<li><img src="http://p3a.pstatp.com/large/1f79000124f9c78620f0"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f77000127ed4e84a22a"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f77000127fc2ccf88e9"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a000128dfdcd131de"></li>'+

        '<li><img src="http://p3a.pstatp.com/large/1f7a00012c6abf228cfa"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f79000128b7d52594bb"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7900012981d473c944"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a00012dc141df0d18"></li>'+

        '<li><img src="http://p3a.pstatp.com/large/1f7700012f1f6535ed61"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a00013029745e1eb3"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a000131229e0b6704"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a00013152f52a4d8a"></li>'+

        '<li><img src="http://p3a.pstatp.com/large/1f770001312c5f566959"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a000132146bc45ada"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7900012f75521df20b"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7a0001345bcfd3c01f"></li>'+

        '<li><img src="http://p3a.pstatp.com/large/1f79000131058bb7f42f"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7900013118e6b7ed6e"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f7900013151b0e49725"></li>'+
        '<li><img src="http://p3a.pstatp.com/large/1f79000133b64a5a3cff"></li>'+
                '</ul>';
    layer.open({
        type: 1,
        title: "分割线", //不显示标题
        area:['80%','80%'],
        shade: [0.8, '#393D49'],
        shadeClose:false,
        content: content,
        closeBtn:0,
        btn: ['确认','取消'],
        yes:function(index, layero){
            var lilen=$('.lineUl li').length;
            for(var i=0;i<lilen;i++){
                if($('.lineUl li:eq('+i+')').hasClass('select')){
                    var lineSrc=$('.lineUl li:eq('+i+') img').attr('src');
                    $('.lineBox img').attr('src',lineSrc);
                    break;
                }
            }
            $('.lineImgSin').attr('src',lineSrc);
            layer.close(index);
        }
    });
    $(document).on('click','.lineUl li',function () {
        $(this).addClass('select').siblings('li').removeClass('select');
    })
})

//刷新预览
$(document).on('click','.refreshBtn',function () {
    var obj;
    var title=$('#titleInp').val();
    var leads=$('.leads').val();
    var t_img;
    if($('.firstImg img').length>0){
        var firstImg=$('.firstImg img').attr('src');
        t_img='<img src="'+firstImg+'">';
    }

    if(title==''){
        layer.msg('请填写标题');
        return;
    }
    else if (title.length<4){
        layer.msg('标题不能少于4个字');
        return;
    }
    else if (title.length>19){
        layer.msg('标题不能多于19个字');
        return;
    }

    if(leads==''){
        layer.msg('请填写导语');
        return;
    }
    else if (leads.length<10){
        layer.msg('导语不能少于10个字');
        return;
    }
    else if (leads.length>100){
        layer.msg('导语不能多于100个字');
        return;
    }
    var len=$('#sortable .IntSingle').length;
    var content=[];
    for (var i=0;i<len;i++){
        var single;
        var addType=$('#sortable .IntSingle:eq('+i+') .IntHead').text();
        if(addType.indexOf('图片')!=-1){
            single={
                type:2,
                img:$('#sortable .IntSingle:eq('+i+') img').attr('src'),
                describe:'',
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('导语')!=-1){
            var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            if(describe==''){
                layer.msg('请填写段落导语');
            }
            else if (describe.length<10){
                layer.msg('段落导语不能少于10个字');
            }
            else if (describe.length>100){
                layer.msg('段落导语不能多于100个字');
            }
            single={
                type:1,
                img:'',
                describe:describe,
                link:'',
                price:'',
                goods_name:'',
                shop_name:''

            }
        }
        else if(addType.indexOf('产品卡')!=-1){
            // var describe=$('#sortable .IntSingle:eq('+i+') textarea').val();
            // if(describe!=''&&(describe.length<10||describe.length>100)){
            //     layer.msg('产品卡的描述必须在10-100字之间');
            // }
            single={
                type:4,
                img:$('#sortable .IntSingle:eq('+i+') .div_left img').attr('src'),
                describe:'',
                // describe:$('#sortable .IntSingle:eq('+i+') .div_right textarea').val(),
                link:$('#sortable .IntSingle:eq('+i+') a').attr('href'),
                price:$('#sortable .IntSingle:eq('+i+') .price').text(),
                goods_name:$('#sortable .IntSingle:eq('+i+') a').text(),
                shop_name:$('#sortable .IntSingle:eq('+i+') .shop_name').text()
            }
        }
        content.push(single);
    }
    var article_content='';
    for (var i=0;i<len;i++){

        if(content[i].type==2){
            article_content+= '<div class="article_img">' +
                '<img  class="tt-img" src="'+content[i].img+'" />' +
                '</div>' ;
        }
        else if(content[i].type==1){
            article_content+= '<div class="article_des">' +
                '<div class="tt-des">'+content[i].describe+'</div>' +
                '</div>' ;
        }
        else if(content[i].type==4){
            article_content+= '<div class="article_card">' +
                '<div class="tt-card">'+
                '<div class="tt-card-left">'+
                '<img  class="tt-img" src="'+content[i].img+'" />' +
                '</div>' +
                '<div class="tt-card-right">'+
                '<a class="tt-link" href="'+content[i].link+'" target="_blank">'+content[i].goods_name+ '</a>' +
                '<p class="tt-price" >￥'+content[i].price+ '</p>' +
                '</div>' +
                '</div>' +
                '</div>' ;
        }
    }

    $('.refresh-preview .tt-title').text(title);
    $('.refresh-preview .tt-first-img').html(t_img);
    $('.refresh-preview .tt-leads').text(leads);
    $('.refresh-preview .tt-content').html(article_content);
})

//添加首图
$(document).on('click','.AddFirstImg',function () {
    // var $IntContent=$(this).parents('.IntContent');
    var imgSrc='https://img.alicdn.com/imgextra/i3/2259497794/TB2ZEbzzoR1BeNjy0FmXXb0wVXa_!!2259497794.jpg_430x430q90.jpg';
    var table='<table class="table table-bordered imgTable">'+
        // '<caption>边框表格布局</caption>'+
        '<thead>'+
        '<tr>'+
        '<th>选择</th>'+
        '<th>类型</th>'+
        '<th>内容</th>'+
        '<th>分类</th>'+
        '<th>来源</th>'+
        '<th>关键字</th>'+
        '<th>修改时间</th>'+
        '</tr>'+
        '</thead>'+
        '<tbody>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '</tbody>'+
        '</table>';
    var content='<section class="content">'+
        '<div class="box" style="border:0 none;">'+
        '<ul id="imgTab" class="nav nav-tabs">'+
        '<li class="active"><a href="#selectImg" data-toggle="tab">选择图片</a></li>'+
        '<li><a href="#uploadImg" data-toggle="tab">上传图片</a></li>'+
        '<li><a href="#pieceImg" data-toggle="tab">图片拼合</a></li>'+
        '</ul>'+
        '<div class="box-body">'+
        '<div id="imgTab" class="tab-content">'+
        '<div class="tab-pane fade in active" id="selectImg">'+
        '<div class="imgSource">'+
        '<span>来源:</span>'+
        '<select class="selectStyle" id="data_source">'+
        '<option value="">全部</option>'+
        '<option value="淘宝">淘宝</option>'+
        '<option value="今日头条">今日头条</option>'+
        '<option value="裁剪图">裁剪图</option>'+
        '<option value="其他">其他</option>'+
        '</select>'+
        '<span style="margin-left: 16px">分类:</span>'+
        '<select class="selectStyle" id="oneUp">'+
        '<option value="">全部</option>'+
        '</select>'+
        '<select class="selectStyle" id="twoUp">'+
        '<option value="">全部</option>'+
        '</select>'+
        '<select class="selectStyle" id="threeUp">'+
        '<option value="">全部</option>'+
        '</select>'+
        '<span style="margin-left: 16px">关键字:</span>'+
        '<select class="selectStyle" id="key_type">'+
        '<option value="1">关键字</option>'+
        '<option value="2">标题</option>'+
        '</select>'+
        '<input type="text" placeholder="请输入关键字/内容" class="inputStyle keywords">'+
        '<button type="button" class="btn btn-primary btn-sm getImgBtn" style="margin-left: 16px">筛选</button>'+
        '</div>'+table+
        '</div>'+
        '<div class="tab-pane fade" id="uploadImg">'+
        '<div class="uploadImgModel">' +
        '<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
        '<div class="head">\n' +
        '<img id="targetImg" />\n' +
        '<input type="file" id="fileImg" style="display: none;"/>\n' +
        '</div>' +
        '</div>'+
        '</div>'+
        '<div class="tab-pane fade" id="pieceImg">'+
        '<div class="pieceImgModel" id="firstsortable">' +
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg1" />' +
        '<span class="upImg1">上传图片</span>'+
        '<input type="file" id="pieceFileImg1" style="display: none;" multiple="multiple"/>' +
        '</div>'+
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg2" />' +
        '<span class="upImg2">上传图片</span>'+
        '<input type="file" id="pieceFileImg2" style="display: none;"/>' +
        '</div>'+
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg3" />' +
        '<span class="upImg3">上传图片</span>'+
        '<input type="file" id="pieceFileImg3" style="display: none;"/>' +
        '</div>'+
        '<button type="button" class="btn btn-primary pImgBtn">拼合</button>\n' +
        '<div class="previewBox">' +
        '<img id="previewImg" />' +
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>';
    layer.open({
        type: 1,
        title: "添加图片", //不显示标题
        area:['80%','100%'],
        shade: [0.8, '#393D49'],
        shadeClose:false,
        content: content,
        closeBtn:0,
        btn: ['确认','取消'],
        yes:function(index, layero){
            if($('#imgTab li:eq(0)').hasClass('active')) {
                var imgSrc;
                var checkedLen=$('input[name="imgRadio"]:checked').length;
                if(checkedLen==1){
                    imgSrc=$('input[name="imgRadio"]:checked').parents('tr').find('img').attr('src');
                    var imgBoxHtml = '<img class="imgSingle" src="' + imgSrc + '" width="100px"/>' +
                        '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-pencil"></span>' +
                        '</button>'+
                        '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-scissors"></span>' +
                        '</button>';
                    $('.firstImg').html(imgBoxHtml);
                }
                else{
                    var imgList=[];
                    for(var i=0;i<checkedLen;i++){
                        $('input[name="imgRadio"]:checked').eq(i).parents('tr').find('img').attr('id','checkedImg'+i);
                        $('input[name="imgRadio"]:checked').eq(i).parents('tr').find('img').attr('crossOrigin', 'anonymous');
                        var imgSrc=$('input[name="imgRadio"]:checked').eq(i).parents('tr').find('img').attr('src');
                        imgList.push(imgSrc);
                    }
                    if(imgList.length==2){
                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                // console.log(imgSrc)
                                var imgBoxHtml = '<img class="imgSingle" src="' + imgSrc + '" width="100px"/>' +
                                    '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-pencil"></span>' +
                                    '</button>'+
                                    '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-scissors"></span>' +
                                    '</button>';
                                $('.firstImg').html(imgBoxHtml);
                            }
                        }
                    }
                    if(imgList.length==3){
                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img3Width=document.getElementById('checkedImg2').naturalWidth;
                        var img3Height=document.getElementById('checkedImg2').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var img3 = new Image();
                        img3.crossOrigin = "Anonymous";
                        img3.src = $('#checkedImg2').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width+img3Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                // console.log(imgSrc)
                                var imgBoxHtml = '<img class="imgSingle" src="' + imgSrc + '" width="100px"/>' +
                                    '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-pencil"></span>' +
                                    '</button>'+
                                    '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                                    '  <span class="glyphicon glyphicon-scissors"></span>' +
                                    '</button>';
                                $('.firstImg').html(imgBoxHtml);
                            }
                        }

                    }
                }

            }
            else if($('#imgTab li:eq(1)').hasClass('active')) {
                if (typeof($('#targetImg').attr('src')) == "undefined") {
                    layer.msg('请选择图片进行裁剪');
                    return;
                }
                var img = new Image();
                img.src = $('#targetImg').attr('src');
                var realWidth = img.width;
                var realHeight = img.height;

                var showWidth = $('#targetImg').css('width');
                showWidth = showWidth.split('px');
                showWidth = parseInt(showWidth[0]);
                var showHeight = $('#targetImg').css('height');
                showHeight = showHeight.split('px');
                showHeight = parseInt(showHeight[0]);

                // 真实图片和显示图片的宽比  高比
                var ratio = realWidth / showWidth;

                var width = $('.uploadImgModel .jcrop-holder>div').css('width');
                if (width == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                width = width.split('px');
                width = parseInt(width[0]) * ratio;
                var height = $('.uploadImgModel .jcrop-holder>div').css('height');
                if (height == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                height = height.split('px');
                height = parseInt(height[0]) * ratio;
                var top = $('.uploadImgModel .jcrop-holder>div').css('top');
                top = top.split('px');
                top = 0 - parseInt(top[0]) * ratio;
                var left = $('.uploadImgModel .jcrop-holder>div').css('left');
                left = left.split('px');
                left = 0 - parseInt(left[0]) * ratio;
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext('2d');
                var base64;
                canvas.width = width;
                canvas.height = height;

                img.onload = function () {
                    this.width = realWidth;
                    this.height = realHeight;
                    ctx.drawImage(this, left, top, this.width, this.height);
                    base64 = canvas.toDataURL('image/jpeg', 1);
                    var imgBoxHtml = '<img class="imgSingle" src="' + base64 + '" width="100px"/>' +
                        '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-pencil"></span>' +
                        '</button>'+
                        '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                        '  <span class="glyphicon glyphicon-scissors"></span>' +
                        '</button>';
                    $('.firstImg').html(imgBoxHtml);
                }
            }
            else if($('#imgTab li:eq(2)').hasClass('active')) {
                var base64=$('#previewImg').attr('src');
                var imgBoxHtml = '<img class="imgSingle" src="' + base64 + '" width="100px"/>' +
                    '<button type="button" class="btn btn-primary btn-sm changeImgBtn">\n' +
                    '  <span class="glyphicon glyphicon-pencil"></span>' +
                    '</button>'+
                    '<button type="button" class="btn btn-primary btn-sm cutImgBtn">\n' +
                    '  <span class="glyphicon glyphicon-scissors"></span>' +
                    '</button>';
                $('.firstImg').html(imgBoxHtml);
            }
            layer.close(index);
        }
    });

    var firstCla=[];
    var secondCla=[];
    var thirdCla=[];
    var claData;
    claData=JSON.parse(localStorage.getItem('get_categories'));
    console.log(claData);
    for (var i=0;i<claData.length;i++) {
        var parent_id=claData[i]['parent_id'];
        if(parent_id==0){
            firstCla.push(claData[i]);
        }
        if(parent_id==5){
            secondCla.push(claData[i]);
        }
        if(parent_id==48){
            thirdCla.push(claData[i]);
        }
    }
    //一级分类默认显示服饰内衣
    var firLen=firstCla.length;
    for (var i=0;i<firLen;i++){
        var option='<option value="'+firstCla[i]['id']+'">'+firstCla[i]['name']+'</option>';
        $('#oneUp').append(option);
        // $("#oneUp").find("option:contains('服饰内衣')").attr("selected",true);
    }
    //二级分类默认显示女装
    var secLen=secondCla.length;
    for (var i=0;i<secLen;i++){
        var option=`<option value="${secondCla[i]['id']}">${secondCla[i]['name']}</option>`;
        $('#twoUp').append(option);
        // $("#twoUp").find("option:contains('女装')").attr("selected",true);
    }
    //三级分类默认显示连衣裙
    var thiLen=thirdCla.length;
    for (var i=0;i<thiLen;i++){
        var option=`<option value="${thirdCla[i]['id']}">${thirdCla[i]['name']}</option>`;
        $('#threeUp').append(option);
        // $("#threeUp").find("option:contains('连衣裙')").attr("selected",true);
    }

    $( "#firstsortable" ).sortable();
    $( "#firstsortable" ).disableSelection();
    $('.pImgBtn').click(function () {
        for (var i=0;i<3;i++) {
            if($('.pieceImgBox:eq('+i+') img').attr('src')!='undefined'){
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+(i+1));
            }
            else{
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+0);
            }
        }
        var img1=$('#pieceTargetImg1').attr('src');
        var img2=$('#pieceTargetImg2').attr('src');
        var img3=$('#pieceTargetImg3').attr('src');
        var img1Width;
        var img1Height;
        var img2Width;
        var img2Height;
        var img3Width;
        var img3Height;
        if(img1!='undefined'){
            img1Width = document.getElementById('pieceTargetImg1').naturalWidth;
            img1Height = document.getElementById('pieceTargetImg1').naturalHeight;
        }
        if(img2!='undefined'){
            img2Width = document.getElementById('pieceTargetImg2').naturalWidth;
            img2Height = document.getElementById('pieceTargetImg2').naturalHeight;
        }
        if(img3!='undefined'){
            img3Width = document.getElementById('pieceTargetImg3').naturalWidth;
            img3Height = document.getElementById('pieceTargetImg3').naturalHeight;
        }
        var img1 = new Image();
        img1.src = $('#pieceTargetImg1').attr('src');
        var img2 = new Image();
        img2.src = $('#pieceTargetImg2').attr('src');
        var img3 = new Image();
        img3.src = $('#pieceTargetImg3').attr('src');

        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        if(img1!='undefined'&&img2!='undefined'&&img3!='undefined'){
            canvas.width = img1Width+img2Width+img3Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
            ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
        }
        else if (img1!='undefined'&&img2!='undefined'&&img3=='undefined') {
            canvas.width = img1Width+img2Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
        }
        base64 = canvas.toDataURL('image/jpeg', 1);
        // console.log(base64);
        $('#previewImg').attr('src',base64);
    });
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    $('.uploadImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.uploadImgModel #fileImg').change(function(){
        changeFileImg()
    });

    //1、打开浏览器
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }
    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }

    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {

        console.log('url===' + url);
        //图片裁剪逻辑
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }

        //初始化图片
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;

                //获取图片真实高度之后
                initJcropImg();//初始化Jcrop插件
                //initCanvasImg();//初始化Canvas内容
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            //onChange: updatePreviewImg,
            //onSelect: updatePreviewImg
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度

            // 保存jcrop_api变量
            jcrop_api = this;

        });
    }

    //初始化预览div内容
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }

    $('.pieceImgModel .upImg1').click(function () {
        openBrowseImg1()
    });

    $('.pieceImgModel #pieceFileImg1').change(function(){
        changeFileImg1()
    });
    function openBrowseImg1(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg1").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg1").dispatchEvent(a);
        }
    }
    function changeFileImg1() {
        var url = getFileUrlImg("pieceFileImg1");
        $('#pieceTargetImg1').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg2').click(function () {
        openBrowseImg2()
    });

    $('.pieceImgModel #pieceFileImg2').change(function(){
        changeFileImg2()
    });
    function openBrowseImg2(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg2").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg2").dispatchEvent(a);
        }
    }
    function changeFileImg2() {
        var url = getFileUrlImg("pieceFileImg2");
        $('#pieceTargetImg2').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg3').click(function () {
        openBrowseImg3()
    });

    $('.pieceImgModel #pieceFileImg3').change(function(){
        changeFileImg3()
    });
    function openBrowseImg3(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg3").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg3").dispatchEvent(a);
        }
    }
    function changeFileImg3() {
        var url = getFileUrlImg("pieceFileImg3");
        $('#pieceTargetImg3').attr('src',url);
        return false;
    }
})

//添加首图--更换图片
$(document).on('click','.firstImg .changeImgBtn',function () {

    var imgSrc='https://img.alicdn.com/imgextra/i3/2259497794/TB2ZEbzzoR1BeNjy0FmXXb0wVXa_!!2259497794.jpg_430x430q90.jpg';
    var table='<table class="table table-bordered imgTable">'+
        // '<caption>边框表格布局</caption>'+
        '<thead>'+
        '<tr>'+
        '<th>选择</th>'+
        '<th>类型</th>'+
        '<th>内容</th>'+
        '<th>分类</th>'+
        '<th>来源</th>'+
        '<th>关键字</th>'+
        '<th>修改时间</th>'+
        '</tr>'+
        '</thead>'+
        '<tbody>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="checkbox" name="imgRadio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '<tr>'+
        '<td><input type="radio"></td>'+
        '<td>图片</td>'+
        '<td><p>文章标题: 百搭单品，你的T恤今天搭好了吗</p><div class="imgBox"><img src="'+imgSrc+'"></div></td>'+
        '<td>服饰内衣</td>'+
        '<td>淘宝</td>'+
        '<td>女半身裙</td>'+
        '<td>2018-08-27 06:10:37</td>'+
        '</tr>'+
        '</tbody>'+
        '</table>';
    var content='<section class="content">'+
        '<div class="box" style="border:0 none;">'+
        '<ul id="imgTab" class="nav nav-tabs">'+
        '<li class="active"><a href="#selectImg" data-toggle="tab">选择图片</a></li>'+
        '<li><a href="#uploadImg" data-toggle="tab">上传图片</a></li>'+
        '<li><a href="#pieceImg" data-toggle="tab">图片拼合</a></li>'+
        '</ul>'+
        '<div class="box-body">'+
        '<div id="imgTab" class="tab-content">'+
        '<div class="tab-pane fade in active" id="selectImg">'+
        '<div class="imgSource">'+
        '<span>来源:</span>'+
        '<select class="selectStyle">'+
        '<option>淘宝</option>'+
        '<option>今日头条</option>'+
        '<option>裁剪图</option>'+
        '<option>其他</option>'+
        '</select>'+
        '<span style="margin-left: 16px">分类:</span>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '<option>电脑办公</option>'+
        '<option>家用电器</option>'+
        '<option>服饰内衣</option>'+
        '</select>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '<option>电脑办公</option>'+
        '<option>家用电器</option>'+
        '<option>服饰内衣</option>'+
        '</select>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '<option>电脑办公</option>'+
        '<option>家用电器</option>'+
        '<option>服饰内衣</option>'+
        '</select>'+
        '<span style="margin-left: 16px">关键字:</span>'+
        '<select class="selectStyle">'+
        '<option>手机</option>'+
        '<option>数码</option>'+
        '</select>'+
        '<input type="text" placeholder="请输入关键字/内容" class="inputStyle">'+
        '<button type="button" class="btn btn-primary getImgBtn" style="margin-left: 16px">筛选</button>'+
        '</div>'+table+
        '</div>'+
        '<div class="tab-pane fade" id="uploadImg">'+
        '<div class="uploadImgModel">' +
        '<button type="button" class="btn btn-primary selImgBtn">选择图片</button>\n' +
        '<div class="head">\n' +
        '<img id="targetImg" />\n' +
        '<input type="file" id="fileImg" style="display: none;"/>\n' +
        '</div>' +
        '</div>'+
        '</div>'+
        '<div class="tab-pane fade" id="pieceImg">'+
        '<div class="pieceImgModel" id="imgsortable">' +
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg1" />' +
        '<span class="upImg1">上传图片</span>'+
        '<input type="file" id="pieceFileImg1" style="display: none;"/>' +
        '</div>'+
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg2" />' +
        '<span class="upImg2">上传图片</span>'+
        '<input type="file" id="pieceFileImg2" style="display: none;"/>' +
        '</div>'+
        '<div class="pieceImgBox">' +
        '<img id="pieceTargetImg3" />' +
        '<span class="upImg3">上传图片</span>'+
        '<input type="file" id="pieceFileImg3" style="display: none;"/>' +
        '</div>'+
        '<button type="button" class="btn btn-primary pImgBtn">拼合</button>\n' +
        '<div class="previewBox">' +
        '<img id="previewImg" />' +
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>'+
        '</div>';
    layer.open({
        type: 1,
        title: "添加图片", //不显示标题
        area:['80%','100%'],
        shade: [0.8, '#393D49'],
        shadeClose:false,
        content: content,
        closeBtn:0,
        btn: ['确认','取消'],
        yes:function(index, layero){
            if($('#imgTab li:eq(0)').hasClass('active')) {
                var imgSrc;
                var checkedLen=$('input[name="imgRadio"]:checked').length;
                if(checkedLen==1){
                    imgSrc=$('input[name="imgRadio"]:checked').parents('tr').find('img').attr('src');
                    $('.firstImg img').attr('src',imgSrc);
                }
                else{
                    var imgList=[];
                    for(var i=0;i<checkedLen;i++){
                        $('input[name="imgRadio"]:checked').eq(i).parents('tr').find('img').attr('id','checkedImg'+i);
                        $('input[name="imgRadio"]:checked').eq(i).parents('tr').find('img').attr('crossOrigin', 'anonymous');
                        var imgSrc=$('input[name="imgRadio"]:checked').eq(i).parents('tr').find('img').attr('src');
                        imgList.push(imgSrc);
                    }
                    if(imgList.length==2){
                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                // console.log(imgSrc)
                                $('.firstImg img').attr('src',imgSrc);
                            }
                        }
                    }
                    if(imgList.length==3){
                        var img1Width=document.getElementById('checkedImg0').naturalWidth;
                        var img1Height=document.getElementById('checkedImg0').naturalHeight;
                        var img2Width=document.getElementById('checkedImg1').naturalWidth;
                        var img2Height=document.getElementById('checkedImg1').naturalHeight;
                        var img3Width=document.getElementById('checkedImg2').naturalWidth;
                        var img3Height=document.getElementById('checkedImg2').naturalHeight;
                        var img1 = new Image();
                        img1.crossOrigin = "Anonymous";
                        img1.src = $('#checkedImg0').attr('src');
                        var img2 = new Image();
                        img2.crossOrigin = "Anonymous";
                        img2.src = $('#checkedImg1').attr('src');
                        var img3 = new Image();
                        img3.crossOrigin = "Anonymous";
                        img3.src = $('#checkedImg2').attr('src');
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext('2d');
                        canvas.width = img1Width+img2Width+img3Width;
                        canvas.height = img1Height;
                        img1.onload = function(){
                            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
                            img2.onload = function () {
                                ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
                                ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
                                imgSrc = canvas.toDataURL('image/jpeg', 1);
                                // console.log(imgSrc)
                                $('.firstImg img').attr('src',imgSrc);
                            }
                        }

                    }
                }
            }
            else if($('#imgTab li:eq(1)').hasClass('active')) {
                if (typeof($('#targetImg').attr('src')) == "undefined") {
                    layer.msg('请选择图片进行裁剪');
                    return;
                }
                var img = new Image();
                img.src = $('#targetImg').attr('src');
                var realWidth = img.width;
                var realHeight = img.height;

                var showWidth = $('#targetImg').css('width');
                showWidth = showWidth.split('px');
                showWidth = parseInt(showWidth[0]);
                var showHeight = $('#targetImg').css('height');
                showHeight = showHeight.split('px');
                showHeight = parseInt(showHeight[0]);

                // 真实图片和显示图片的宽比  高比
                var ratio = realWidth / showWidth;

                var width = $('.uploadImgModel .jcrop-holder>div').css('width');
                if (width == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                width = width.split('px');
                width = parseInt(width[0]) * ratio;
                var height = $('.uploadImgModel .jcrop-holder>div').css('height');
                if (height == '0px') {
                    layer.msg('请裁剪图片再点击确定');
                    return;
                }
                height = height.split('px');
                height = parseInt(height[0]) * ratio;
                var top = $('.uploadImgModel .jcrop-holder>div').css('top');
                top = top.split('px');
                top = 0 - parseInt(top[0]) * ratio;
                var left = $('.uploadImgModel .jcrop-holder>div').css('left');
                left = left.split('px');
                left = 0 - parseInt(left[0]) * ratio;
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext('2d');
                var base64;
                canvas.width = width;
                canvas.height = height;

                img.onload = function () {
                    this.width = realWidth;
                    this.height = realHeight;
                    ctx.drawImage(this, left, top, this.width, this.height);
                    base64 = canvas.toDataURL('image/jpeg', 1);
                    $('.firstImg img').attr('src',base64);
                }
            }
            else if($('#imgTab li:eq(2)').hasClass('active')) {
                var base64=$('#previewImg').attr('src');
                $('.firstImg img').attr('src',base64);
            }
            layer.close(index);
        }
    });
    $( "#imgsortable" ).sortable();
    $( "#imgsortable" ).disableSelection();
    $('.pImgBtn').click(function () {
        for (var i=0;i<3;i++) {
            if($('.pieceImgBox:eq('+i+') img').attr('src')!='undefined'){
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+(i+1));
            }
            else{
                $('.pieceImgBox:eq('+i+') img').attr('id','pieceTargetImg'+0);
            }
        }
        var img1=$('#pieceTargetImg1').attr('src');
        var img2=$('#pieceTargetImg2').attr('src');
        var img3=$('#pieceTargetImg3').attr('src');
        var img1Width;
        var img1Height;
        var img2Width;
        var img2Height;
        var img3Width;
        var img3Height;
        if(img1!='undefined'){
            img1Width = document.getElementById('pieceTargetImg1').naturalWidth;
            img1Height = document.getElementById('pieceTargetImg1').naturalHeight;
        }
        if(img2!='undefined'){
            img2Width = document.getElementById('pieceTargetImg2').naturalWidth;
            img2Height = document.getElementById('pieceTargetImg2').naturalHeight;
        }
        if(img3!='undefined'){
            img3Width = document.getElementById('pieceTargetImg3').naturalWidth;
            img3Height = document.getElementById('pieceTargetImg3').naturalHeight;
        }
        var img1 = new Image();
        img1.src = $('#pieceTargetImg1').attr('src');
        var img2 = new Image();
        img2.src = $('#pieceTargetImg2').attr('src');
        var img3 = new Image();
        img3.src = $('#pieceTargetImg3').attr('src');

        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        if(img1!='undefined'&&img2!='undefined'&&img3!='undefined'){
            canvas.width = img1Width+img2Width+img3Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
            ctx.drawImage(img3, (img1Width+img2Width), 0, img3Width, img3Height);
        }
        else if (img1!='undefined'&&img2!='undefined'&&img3=='undefined') {
            canvas.width = img1Width+img2Width;
            canvas.height = img1Height;
            ctx.drawImage(img1, 0, 0, img1Width, img1Height);
            ctx.drawImage(img2, img1Width, 0, img2Width, img2Height);
        }
        base64 = canvas.toDataURL('image/jpeg', 1);
        // console.log(base64);
        $('#previewImg').attr('src',base64);
    });
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    $('.uploadImgModel .selImgBtn').click(function () {
        openBrowseImg()
    });

    $('.uploadImgModel #fileImg').change(function(){
        changeFileImg()
    });

    //1、打开浏览器
    function openBrowseImg(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("fileImg").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("fileImg").dispatchEvent(a);
        }
    }
    //2、从 file 域获取 本地图片 url
    function getFileUrlImg(sourceId) {
        var url;
        if (navigator.userAgent.indexOf("MSIE")>=1) { // IE
            url = document.getElementById(sourceId).value;
        } else if(navigator.userAgent.indexOf("Firefox")>0) { // Firefox
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Chrome")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        } else if(navigator.userAgent.indexOf("Safari")>0) { // Chrome
            url = window.URL.createObjectURL(document.getElementById(sourceId).files.item(0));
        }
        return url;
    }
    //选择文件事件
    function changeFileImg() {
        var url = getFileUrlImg("fileImg");//根据id获取文件路径
        preImgImg(url);
        return false;
    }

    //3、将本地图片 显示到浏览器上
    function preImgImg(url) {

        console.log('url===' + url);
        //图片裁剪逻辑
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }

        //初始化图片
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;

                //获取图片真实高度之后
                initJcropImg();//初始化Jcrop插件
                //initCanvasImg();//初始化Canvas内容
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            //onChange: updatePreviewImg,
            //onSelect: updatePreviewImg
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度

            // 保存jcrop_api变量
            jcrop_api = this;

        });
    }

    //初始化预览div内容
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }

    $('.pieceImgModel .upImg1').click(function () {
        openBrowseImg1()
    });

    $('.pieceImgModel #pieceFileImg1').change(function(){
        changeFileImg1()
    });
    function openBrowseImg1(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg1").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg1").dispatchEvent(a);
        }
    }
    function changeFileImg1() {
        var url = getFileUrlImg("pieceFileImg1");
        $('#pieceTargetImg1').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg2').click(function () {
        openBrowseImg2()
    });

    $('.pieceImgModel #pieceFileImg2').change(function(){
        changeFileImg2()
    });
    function openBrowseImg2(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg2").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg2").dispatchEvent(a);
        }
    }
    function changeFileImg2() {
        var url = getFileUrlImg("pieceFileImg2");
        $('#pieceTargetImg2').attr('src',url);
        return false;
    }

    $('.pieceImgModel .upImg3').click(function () {
        openBrowseImg3()
    });

    $('.pieceImgModel #pieceFileImg3').change(function(){
        changeFileImg3()
    });
    function openBrowseImg3(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("pieceFileImg3").click();
        }else{
            var a=document.createEvent("MouseEvents");
            a.initEvent("click", true, true);
            document.getElementById("pieceFileImg3").dispatchEvent(a);
        }
    }
    function changeFileImg3() {
        var url = getFileUrlImg("pieceFileImg3");
        $('#pieceTargetImg3').attr('src',url);
        return false;
    }
})
//添加首图--裁剪图片
$(document).on('click','.firstImg .cutImgBtn', function () {
    // $imgSingle=$(this).siblings('.imgSingle');
    var imgSrc=$(this).siblings('.imgSingle').attr('src');
    var changeImgModel='<div class="changeImgModel">\n' +
        '\t\t\t\t<button type="button" class="btn btn-success sureImgBtn">确定</button>\n' +
        '\t\t\t\t<button type="button" class="btn btn-warning closeImgBtn">取消</button>'+
        '\t\t\t<div class="head">\n' +
        '\t\t\t\t<img src="'+imgSrc+'"  id="targetImg"/>\n' +
        '\t\t\t</div>\n' +
        '\t\t</div>';
    $('html body').append(changeImgModel);
    // 定义一些使用的变量
    var jcrop_api,//jcrop对象
        boundx,//图片实际显示宽度
        boundy,//图片实际显示高度
        realWidth,// 真实图片宽度
        realHeight, //真实图片高度
        // 使用的jquery对象
        $targetImg = $('#targetImg');

    preImgImg(imgSrc);
    $('.changeImgModel .sureImgBtn').click(function () {
        var img = new Image();
        img.src = $('#targetImg').attr('src');
        var realWidth = img.width;
        var realHeight = img.height;
        if(img.src.indexOf('http')!=-1){
            img.crossOrigin = "Anonymous";
            img.src = $('#targetImg').attr('src');
        }

        var showWidth=$('#targetImg').css('width');
        showWidth=showWidth.split('px');
        showWidth=parseInt(showWidth[0]);
        var showHeight=$('#targetImg').css('height');
        showHeight=showHeight.split('px');
        showHeight=parseInt(showHeight[0]);

        // 真实图片和显示图片的宽比  高比
        var ratio=realWidth/showWidth;

        var width=$('.changeImgModel .jcrop-holder>div').css('width');
        if(width=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        width=width.split('px');
        width=parseInt(width[0])*ratio;
        var height=$('.changeImgModel .jcrop-holder>div').css('height');
        if(height=='0px'){
            layer.msg('请裁剪图片再点击确定');
            return;
        }
        height=height.split('px');
        height=parseInt(height[0])*ratio;
        var top=$('.changeImgModel .jcrop-holder>div').css('top');
        top=top.split('px');
        top=0-parseInt(top[0])*ratio;
        var left=$('.changeImgModel .jcrop-holder>div').css('left');
        left=left.split('px');
        left=0-parseInt(left[0])*ratio;
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var base64;
        canvas.width = width;
        canvas.height = height;

        img.onload = function() {
            this.width = realWidth;
            this.height = realHeight;
            ctx.drawImage(this, left, top, this.width, this.height);
            base64 = canvas.toDataURL('image/jpeg', 1);
            // console.log(base64);
            $('.changeImgModel').remove();
            $('.firstImg img').attr('src',base64);
        }
    });

    $('.changeImgModel .closeImgBtn').click(function () {
        $('.changeImgModel').remove();
    });
    function preImgImg(url) {
        if(jcrop_api)//判断jcrop_api是否被初始化过
        {
            jcrop_api.destroy();
        }
        initTargetImg();
        var image = document.getElementById('targetImg');
        image.onload=function(){//图片加载是一个异步的过程
            //获取图片文件真实宽度和大小
            var img = new Image();
            img.onload=function(){
                realWidth = img.width;
                realHeight = img.height;
                initJcropImg();
            };
            img.src = url;
        };
        image.src = url;
    }

    //初始化Jcrop插件
    function initJcropImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.Jcrop({
            // aspectRatio: 513 / 513
        },function(){
            //初始化后回调函数
            // 获取图片实际显示的大小
            var bounds = this.getBounds();
            boundx = bounds[0];//图片实际显示宽度
            boundy = bounds[1];//图片实际显示高度
            jcrop_api = this;
        });
    }
    function initTargetImg(){
        $targetImg.removeAttr("style");//清空上一次初始化设置的样式
        $targetImg.css({
            maxWidth:  '100%',
            maxHeight: '100%'
        });
    }
})

//级联
$(document).on('change','#oneUp',function(){
    var claData=JSON.parse(localStorage.getItem('get_categories'));
    $(this).siblings('select').empty();
    var sel=$(this).find('option:selected').val();
    var num=0;
    for (var i=0;i<claData.length;i++) {
        var parent_id=claData[i]['parent_id'];
        if(parent_id==sel){
            num++;
            var option=`<option value="${claData[i]['id']}">${claData[i]['name']}</option>`;
            $(this).siblings('#twoUp').append(option);
            if(num==1){
                var sel_two=$(this).siblings('#twoUp').find('option:selected').val();
                console.log('二级ID'+sel_two);
                for (var k=0;k<claData.length;k++) {
                    var parent_id=claData[k]['parent_id'];
                    if(parent_id==sel_two){
                        var option=`<option value="${claData[k]['id']}">${claData[k]['name']}</option>`;
                        $(this).siblings('#threeUp').append(option);
                    }
                }
            }
        }
    }
})

$(document).on('change','#twoUp',function(){
    var claData=JSON.parse(localStorage.getItem('get_categories'));
    $(this).siblings('#threeUp').empty();
    var sel=$(this).find('option:selected').val();
    for (var i=0;i<claData.length;i++) {
        var parent_id=claData[i]['parent_id'];
        if(parent_id==sel){
            var option=`<option value="${claData[i]['id']}">${claData[i]['name']}</option>`;
            $(this).siblings('#threeUp').append(option);
        }
    }
})

//筛选图片
$(document).on('click','.getImgBtn',function () {
    $.post(
        '/admin/base/get_img_data',
        {
            _token :  $("input[name='_token']").val(),
            first_cid:$('#oneUp').val(),
            second_cid:$('#twoUp').val(),
            third_cid:$('#threeUp').val(),
            data_source:$('#data_source').val(),
            key_type:$('#key_type').val(),
            keywords:$('.keywords').val(),
            page_count:20,
            page:1
        },
        function (res) {
            console.log(res)
        }
    )
})









